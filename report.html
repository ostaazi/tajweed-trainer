<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tajweedy — تقرير نتيجة الاختبار</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
  <div class="container">
    <header>
      <img src="assets/logo-tajweedy.png" alt="Tajweedy" onerror="this.style.display='none'">
      <div>
        <h1>Tajweedy — تقرير نتيجة الاختبار</h1>
        <div class="muted">ملخّص دقيق لإجاباتك مع الحكم على كل سؤال</div>
      </div>
      <div class="toolbar" style="margin-inline-start:auto;display:flex;gap:8px">
        <button class="btn" onclick="toggleTheme()">الوضع الليلي</button>
        <button class="btn" onclick="copyReport()">نسخ النتائج</button>
        <button class="btn" onclick="window.print()">تنزيل/طباعة</button>
      </div>
    </header>

    <section class="card" id="metaCard"></section>

    <section class="card">
      <table class="table" id="tbl">
        <thead>
          <tr>
            <th class="center" style="width:54px">#</th>
            <th>السؤال</th>
            <th style="width:140px">اختياراتك</th>
            <th style="width:120px">الصحيح</th>
            <th class="center" style="width:70px">الحُكم</th>
            <th>لماذا؟</th>
          </tr>
        </thead>
        <tbody id="tbody"><tr><td colspan="6" class="center muted">لا توجد بيانات.</td></tr></tbody>
      </table>
      <div class="row" style="justify-content:flex-end;margin-top:10px">
        <button class="btn" onclick="copyReport()">نسخ النتائج</button>
        <button class="btn" onclick="window.print()">تنزيل/طباعة</button>
      </div>
      <div class="muted" style="margin-top:10px">* تعرض خلية <strong>الحُكم</strong> رمز ✅ عند الإجابة الصحيحة و ❌ عند الخطأ.</div>
    </section>
  </div>

<script>
function toggleTheme(){ const d=document.documentElement; d.dataset.theme = d.dataset.theme==='dark' ? '' : 'dark'; }
function getReport(){
  if (window.reportData && window.reportData.items) return window.reportData;
  try{
    const raw = localStorage.getItem('tajweedy_last_report')
             || localStorage.getItem('tajweed_last_report');
    if (!raw) return null;
    const obj = JSON.parse(raw);
    if (obj && Array.isArray(obj.items)) return obj;
  }catch(e){}
  const now=new Date().toISOString();
  return { traineeName:"متدرّب", sectionLabel:"النون الساكنة والتنوين", score:{correct:1,total:5}, takenAt:now, items:[
    { no:1, question:"ما حكم التنوين؟ (المثال: مِنْ آمن)", options:["إظهار","إدغام بغنة","إقلاب","إخفاء"], chosen:"إظهار", answer:"إدغام بغنة", isCorrect:false, rationale:"إدغام بغنة إذا تبعت النون/التنوين أحد حروف ينمو."}
  ]};
}
function fillMeta(r){
  const el=document.getElementById('metaCard'); const date=new Date(r.takenAt||Date.now());
  el.innerHTML = `<div class="row" style="justify-content:space-between">
    <div class="row"><span class="badge">القسم: ${r.sectionLabel||'غير محدد'}</span><span class="badge">النتيجة: ${r.score?.correct||0} / ${r.score?.total||0}</span></div>
    <div class="row">${r.traineeName?`<span class="badge">👤 ${r.traineeName}</span>`:''}<span class="badge">🗓️ ${date.toLocaleString('ar')}</span></div>
  </div>`;
}
function fillTable(r){
  const body=document.getElementById('tbody');
  if(!r.items || !r.items.length){ body.innerHTML = `<tr><td colspan="6" class="center muted">لا توجد بيانات.</td></tr>`; return; }
  body.innerHTML = r.items.map(it=>{
    const icon = it.isCorrect ? '✅' : '❌';
    const cls  = it.isCorrect ? 'ok' : 'bad';
    const chosen = (it.chosen ?? '').toString();
    const answer = (it.answer ?? '').toString();
    const highlight = (txt, needle, ok)=>{
      if(!txt || !needle) return txt;
      try{ const esc=needle.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
        return txt.replace(new RegExp(`(${esc})`,'g'), `<mark style="background:${ok?'#dcfce7':'#fee2e2'};padding:0 4px;border-radius:4px">${needle}</mark>`);
      }catch(e){return txt;}
    };
    return `<tr>
      <td class="center">${it.no ?? ''}</td>
      <td>${it.question || ''}</td>
      <td>${highlight(chosen, chosen, it.isCorrect)}</td>
      <td>${highlight(answer, answer, true)}</td>
      <td class="center ${cls}">${icon}</td>
      <td><span class="muted">${it.rationale || ''}</span></td>
    </tr>`;
  }).join('');
}
function copyReport(){
  const sel = window.getSelection(); const range = document.createRange();
  range.selectNode(document.getElementById('tbl')); sel.removeAllRanges(); sel.addRange(range);
  try{ document.execCommand('copy'); sel.removeAllRanges(); alert('✅ تم نسخ الجدول إلى الحافظة.'); }
  catch(e){ sel.removeAllRanges(); navigator.clipboard?.writeText(document.getElementById('tbl').innerText).then(()=>alert('✅ تم نسخ النص.')).catch(()=>alert('⚠️ تعذّر النسخ تلقائيًا.')); }
}
(function(){ const r=getReport(); fillMeta(r); fillTable(r); })();
</script>
</body>
</html>
