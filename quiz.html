<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>التجويد — الاختبار</title>
<style>
:root{
  --bg:#0f172a; --fg:#e5e7eb; --muted:#94a3b8; --accent:#8b5cf6;
  --card:#111827; --ok:#16a34a; --bad:#ef4444; --chip-bg:#1f2937; --chip-fg:#e5e7eb;
  --seg-a:#e4dafe; --seg-b:#efd3ff; --seg-c:#ffeab5; 
}
html.light{ --bg:#ffffff; --fg:#0f172a; --muted:#334155; --card:#f8fafc; --chip-bg:#e2e8f0; --chip-fg:#0f172a; }
body{ margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Naskh Arabic UI", "Tajawal", sans-serif; background:var(--bg); color:var(--fg);}
.container{max-width:900px;margin:24px auto;padding:0 16px;}
h1{font-size:28px;margin:0 0 12px 0}
.controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:12px 0}
select,input[type=text]{padding:10px 12px;border-radius:10px;border:1px solid #0000;background:var(--card);color:var(--fg)}
.btn{background:#4338ca;color:#fff;border:0;padding:10px 14px;border-radius:12px;cursor:pointer}
.btn.ghost{background:transparent;border:1px solid var(--muted);color:var(--fg)}
.btn.red{background:#e11d48}
.btn.green{background:#16a34a}
.badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:var(--chip-bg);color:var(--chip-fg);font-size:14px}
.toggle{margin-inline-start:auto;border:1px dashed var(--muted);border-radius:12px;padding:8px 10px;display:flex;gap:8px;align-items:center;cursor:pointer}
.range{width:100%}
.label{color:var(--muted);margin-top:8px}
.trislider{position:relative;height:38px;border-radius:14px;overflow:hidden;background:var(--card);box-shadow:inset 0 0 0 1px #0001;margin-top:8px}
.seg{position:absolute;top:0;bottom:0;display:flex;align-items:center;justify-content:center;font-weight:700;color:#111}
.seg.a{background:#c7d2fe;color:#111}
.seg.b{background:#e9d5ff;color:#111}
.seg.c{background:#fde68a;color:#111}
.handle{position:absolute;top:0;bottom:0;width:10px;background:var(--bg);box-shadow:0 0 0 2px #0002;cursor:ew-resize}
.question{background:var(--card);border-radius:14px;padding:14px;margin:18px 0;border:1px solid #0001}
.qtext{font-size:22px;line-height:2}
.options{display:grid;gap:10px;margin-top:10px}
.opt{display:flex;align-items:center;gap:12px;background:transparent;border:1px solid #0002;border-radius:12px;padding:10px}
.opt input{width:20px;height:20px}
.footer{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:14px}
.ayah-target{color:#15803d !important;font-weight:700;font-size:1.25em;background:#e6f4ea;border-radius:6px;padding:1px 4px}
.small{font-size:13px;color:var(--muted)}
.result{background:var(--card);border-radius:16px;padding:12px;margin:16px 0;border:1px solid #0001}
.hidden{display:none}
hr{border:0;border-top:1px solid #0002;margin:18px 0}
/* toggle icon contrast */
.icon{width:18px;height:18px;display:inline-block;border-radius:50%;background:linear-gradient(135deg,#fde68a 0 50%,#111827 50% 100%);box-shadow:0 0 0 2px #fff2}
html.light .icon{box-shadow:0 0 0 2px #0002}
/* rtl helpers for mobile tap */
.handle:after{content:"";position:absolute;top:0;bottom:0;left:0;right:0}
</style>
</head>
<body>
<div class="container">
  <div class="controls">
    <button id="endBtn" class="btn red">إنهاء الاختبار</button>
    <button id="startShort" class="btn ghost">بدء اختبار قصير (٥ أسئلة للقسم المحدد)</button>
    <input id="trainee" type="text" placeholder="اسم المتدرب">
    <select id="section">
      <option value="noon_tanween">النون الساكنة والتنوين</option>
      <option value="meem_sakinah">الميم الساكنة</option>
      <option value="madd">أحكام المدود</option>
    </select>
    <div id="themeToggle" class="toggle"><span class="icon"></span><span id="themeLabel">☾/☀︎</span></div>
  </div>

  <div class="controls">
    <span class="label">حدّد عدد أسئلة الاختبار</span>
    <input id="totalRange" class="range" type="range" min="5" max="100" step="1" value="20">
    <span id="totalShow">20</span>
  </div>

  <div class="label">انقر أو اسحب الفواصل لتعديل العرض % بين الأقسام.</div>
  <div class="trislider" id="trislider">
    <div class="seg a" id="segA">33%</div>
    <div class="seg b" id="segB">33%</div>
    <div class="seg c" id="segC">34%</div>
    <div class="handle" id="h1"></div>
    <div class="handle" id="h2"></div>
  </div>
  <div class="controls">
     <span class="badge" style="background:#c7d2fe;color:#111">النون الساكنة والتنوين</span>
     <span class="badge" style="background:#e9d5ff;color:#111">الميم الساكنة</span>
     <span class="badge" style="background:#fde68a;color:#111">أحكام المدود</span>
     <span class="small" id="bankInfo"></span>
  </div>

  <div class="footer">
    <button id="startFull" class="btn">بدء اختبار شامل</button>
    <button id="gradeBtn" class="btn green">تصحيح</button>
  </div>

  <div id="quiz"></div>
  <div id="result" class="result hidden"></div>
</div>

<script>
// ---------- theme toggle ----------
(function(){
  const toggle = document.getElementById('themeToggle');
  const stored = localStorage.getItem('tajweed-theme');
  if(stored==='light') document.documentElement.classList.add('light');
  toggle.addEventListener('click',()=>{
    document.documentElement.classList.toggle('light');
    localStorage.setItem('tajweed-theme', document.documentElement.classList.contains('light')?'light':'dark');
  });
})();

// ---------- tri slider ----------
const tri = document.getElementById('trislider');
const segA=document.getElementById('segA'), segB=document.getElementById('segB'), segC=document.getElementById('segC');
const h1=document.getElementById('h1'), h2=document.getElementById('h2');
let totalWidth; let p1=33, p2=66; // handles as percentages of width (0..100)
function layout(){
  totalWidth = tri.clientWidth;
  const aW = Math.round(p1/100*totalWidth);
  const bW = Math.round((p2-p1)/100*totalWidth);
  const cW = totalWidth - aW - bW;
  segA.style.left='0px'; segA.style.width=aW+'px'; segA.textContent=Math.round(p1)+'%';
  segB.style.left=aW+'px'; segB.style.width=bW+'px'; segB.textContent=Math.round(p2-p1)+'%';
  segC.style.left=(aW+bW)+'px'; segC.style.width=cW+'px'; segC.textContent=Math.round(100-p2)+'%';
  h1.style.left=(aW-5)+'px'; h2.style.left=(aW+bW-5)+'px';
}
function clamp(v,min,max){return Math.max(min,Math.min(max,v));}
function attach(handle, which){
  let startX=0;
  const onMove = (ev)=>{
    const x = (ev.touches?ev.touches[0].clientX:ev.clientX) - tri.getBoundingClientRect().left;
    const perc = clamp(x/totalWidth*100, 0, 100);
    if(which===1){ p1 = clamp(perc, 0, p2-5); }
    else { p2 = clamp(perc, p1+5, 100); }
    layout();
  };
  const end=()=>{document.removeEventListener('mousemove',onMove);document.removeEventListener('touchmove',onMove,{passive:false});}
  handle.addEventListener('mousedown',e=>{e.preventDefault();document.addEventListener('mousemove',onMove);});
  handle.addEventListener('touchstart',e=>{e.preventDefault();document.addEventListener('touchmove',onMove,{passive:false});});
  document.addEventListener('mouseup',end);document.addEventListener('touchend',end);
}
window.addEventListener('resize', layout);
attach(h1,1); attach(h2,2); layout();

// ---------- state ----------
const totalRange = document.getElementById('totalRange');
const totalShow  = document.getElementById('totalShow');
totalRange.addEventListener('input',()=> totalShow.textContent=totalRange.value);
totalShow.textContent=totalRange.value;

let BANK=null, FLAT=[];
async function loadBank(){
  const res = await fetch('questions_bank.json',{cache:'no-store'});
  if(!res.ok){ alert('تعذر تحميل بنك الأسئلة'); return; }
  const data = await res.json();
  BANK = data.sections || data;
  // flatten
  const map = {
    'noon_tanween':'النون الساكنة والتنوين',
    'meem_sakinah':'الميم الساكنة',
    'madd':'أحكام المدود'
  };
  FLAT = [];
  for (const key of ['noon_tanween','meem_sakinah','madd']){
    const sec = BANK[key]; if(!sec) continue;
    for(const partName in (sec.parts||{})){
      const arr = sec.parts[partName]||[];
      for(const q of arr){
        FLAT.push({section:key, part:partName, ...q});
      }
    }
  }
  document.getElementById('bankInfo').textContent = 'تم التحميل: ' + FLAT.length + ' سؤالًا';
}
loadBank();

// ---------- helpers ----------
function highlightTargets(text){
  return text.replace(/\[\[(.+?)\]\]/g,(m,word)=>'<span class="ayah-target">'+word+'</span>');
}
function createQuestionEl(idx, q){
  const wrap = document.createElement('div'); wrap.className='question';
  const qtext = document.createElement('div'); qtext.className='qtext';
  qtext.innerHTML = (idx+1)+'. قال تعالى: ' + highlightTargets(q.question || '');
  wrap.appendChild(qtext);
  const options = document.createElement('div'); options.className='options';
  const labels = (q.options && q.options.length)? q.options : ['إظهار','إدغام','إخفاء','إقلاب'];
  labels.forEach((label,i)=>{
    const id = 'q'+idx+'o'+i;
    const row = document.createElement('label'); row.className='opt';
    row.innerHTML = '<input type="radio" name="q'+idx+'" value="'+i+'"><span>'+label+'</span>';
    options.appendChild(row);
  });
  wrap.appendChild(options);
  return wrap;
}
function sample(arr, n){ const a=arr.slice(); const out=[]; while(a.length && out.length<n){ out.push(a.splice(Math.floor(Math.random()*a.length),1)[0]); } return out; }

// ---------- build quiz ----------
const quizDiv = document.getElementById('quiz');
function buildQuizShort(){
  if(!FLAT.length){ alert('لم يتم تحميل الأسئلة'); return; }
  const sec = document.getElementById('section').value;
  const pool = FLAT.filter(q=>q.section===sec);
  const items = sample(pool, 5);
  renderQuiz(items);
}
function buildQuizFull(){
  if(!FLAT.length){ alert('لم يتم تحميل الأسئلة'); return; }
  const total = parseInt(totalRange.value,10);
  const nA = Math.round(total * (p1/100));
  const nB = Math.round(total * ((p2-p1)/100));
  const nC = total - nA - nB;
  const A = sample(FLAT.filter(q=>q.section==='noon_tanween'), Math.min(nA,  FLAT.length));
  const B = sample(FLAT.filter(q=>q.section==='meem_sakinah'), Math.min(nB,  FLAT.length));
  const C = sample(FLAT.filter(q=>q.section==='madd'), Math.min(nC,  FLAT.length));
  // إذا حدث نقص بسبب عدم كفاية قسم، نكمل من بقية الأقسام
  let items = [...A, ...B, ...C];
  while(items.length < total){
    const candidate = FLAT[Math.floor(Math.random()*FLAT.length)];
    if(!items.includes(candidate)) items.push(candidate);
  }
  renderQuiz(items.slice(0,total));
}
function renderQuiz(items){
  quizDiv.innerHTML='';
  items.forEach((q,idx)=> quizDiv.appendChild(createQuestionEl(idx,q)));
  quizDiv.dataset.count = items.length;
  window._CURRENT_ITEMS = items; // للاستخدام في التصحيح
  document.getElementById('result').classList.add('hidden');
}

// ---------- grading ----------
function grade(){
  const items = window._CURRENT_ITEMS || [];
  if(!items.length){ alert('ابدأ الاختبار أولًا'); return; }
  let correct=0;
  const details=[];
  items.forEach((q,idx)=>{
    const sel = document.querySelector('input[name="q'+idx+'"]:checked');
    const ansIndex = typeof q.answer==='number' ? q.answer : null;
    const labels = (q.options && q.options.length)? q.options : ['إظهار','إدغام','إخفاء','إقلاب'];
    const correctLabel = (ansIndex!=null && labels[ansIndex]!=null) ? labels[ansIndex] : 'غير متاح';
    const userLabel = sel ? labels[parseInt(sel.value,10)] : '— —';
    const ok = sel && (parseInt(sel.value,10)===ansIndex);
    if(ok) correct++;
    details.push({idx:idx+1, ok, q, correctLabel, userLabel});
  });
  const percent = Math.round((correct/items.length)*100);
  // عرض النسخة المصححة فقط
  const res = document.getElementById('result');
  res.classList.remove('hidden');
  res.innerHTML = `<h2>النتيجة التفصيلية</h2>
  <div class="badge">${percent}% (${correct}/${items.length})</div>
  <hr>` + details.map(d=>`
    <div class="question">
      <div class="qtext">${d.idx}. قال تعالى: ${highlightTargets(d.q.question||'')}</div>
      <div class="small">إجابتك: ${d.userLabel} — <b>الصحيح:</b> ${d.correctLabel}</div>
    </div>
  `).join('');
  res.scrollIntoView({behavior:'smooth'});
}

// ---------- events ----------
document.getElementById('startShort').onclick = buildQuizShort;
document.getElementById('startFull').onclick  = buildQuizFull;
document.getElementById('gradeBtn').onclick   = grade;
document.getElementById('endBtn').onclick     = grade;
</script>
</body>
</html>
