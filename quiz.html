<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>التجويد – الاختبار</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <h1>إعداد الاختبار</h1>

    <div class="toolbar">
      <select id="section">
        <option value="noon_tanween">النون الساكنة والتنوين</option>
        <option value="meem_sakinah">الميم الساكنة</option>
        <option value="madd_rules">أحكام المدود</option>
      </select>
      <input id="trainee" placeholder="اسم المتدرّب" style="min-width:220px">
      <button class="button" id="btnShort">بدء اختبار قصير (٥ أسئلة)</button>
      <span class="meta">— أو —</span>
      <input type="range" min="5" max="100" value="20" id="totalRange" class="range">
      <span id="totalLabel" class="meta">حدد عدد أسئلة الاختبار: <b>20</b></span>
      <button class="button secondary" id="btnFull">بدء اختبار شامل</button>
      <button class="button danger" id="btnFinish" style="display:none">إنهاء الاختبار</button>
    </div>

    <div class="badges">
      <span class="badge"><span class="dot"></span> النون الساكنة والتنوين</span>
      <span class="badge m2"><span class="dot"></span> الميم الساكنة</span>
      <span class="badge ok"><span class="dot" style="background:var(--ok)"></span> أحكام المدود</span>
    </div>

    <div class="meta" id="loadMeta">…</div>
    <hr>

    <div id="quiz"></div>

    <div class="footer">
      <button class="button" id="btnGrade" style="display:none">تصحيح</button>
      <button class="button ghost" id="btnExportCSV" style="display:none">تصدير CSV</button>
      <button class="button ghost" id="btnPrint" style="display:none">طباعة/حفظ PDF</button>
      <a class="button" id="btnReview" href="results.html" style="display:none">عرض النتيجة التفصيلية</a>
      <span id="scoreBox" class="card small" style="display:none"></span>
    </div>
  </div>

<script>
const bankUrl = 'questions_bank.json';
let BANK=null, CURRENT=[], ANSWERS=[], META={}, traineeName='';

// mapping for answer indices
const MAPS = {
  noontan: ['إظهار','إدغام','إخفاء','إقلاب'],
  meem: ['إظهار شفوي','إدغام شفوي','إخفاء شفوي','قلب'],
  madd: ['مد طبيعي','مد متصل','مد منفصل','مد لازم']
};

function $(q){return document.querySelector(q)}
function htm(l){return l.join('')}

function applyAyahHighlight(root=document){
  const nodes = root.querySelectorAll('.q-stem, .question, .ayah, .question-text');
  nodes.forEach(el=>{
    const html = el.innerHTML; if(!html) return;
    if(html.indexOf('ayah-target')!==-1) return;
    const replaced = html.replace(/\[\[([\s\S]*?)\]\]/g,'<span class="ayah-target">$1</span>');
    if(replaced!==html) el.innerHTML=replaced;
  });
}

function flattenSection(key){
  const sec = BANK.sections[key];
  const parts = sec ? sec.parts : {};
  let all=[];
  Object.values(parts).forEach(arr=>{ all=all.concat(arr)});
  return all;
}

function pickN(arr, n){
  const a=arr.slice(); const out=[];
  while(out.length<Math.min(n,a.length)){
    const i = Math.floor(Math.random()*a.length);
    out.push(a.splice(i,1)[0]);
  }
  return out;
}

function optionLabels(sectionKey){
  if(sectionKey==='noon_tanween') return MAPS.noontan;
  if(sectionKey==='meem_sakinah') return MAPS.meem;
  if(sectionKey==='madd_rules') return MAPS.madd;
  return [];
}

function renderQuiz(list, sectionKey){
  const opts = optionLabels(sectionKey);
  const qhtml = list.map((q,idx)=>{
    const qid = 'q'+idx;
    return `<div class="question" data-ans="${q.answer||0}" data-sec="${sectionKey}" data-q="${q.qnum||idx+1}">
      <div class="q-stem ayah">${idx+1}. ${q.question || ''}</div>
      <div class="opts">
        ${opts.map((t,i)=>`<label class="opt"><input type="radio" name="${qid}" value="${i+1}"> ${t}</label>`).join('')}
      </div>
    </div>`;
  });
  $('#quiz').innerHTML = qhtml.join('');
  applyAyahHighlight(document);
  $('#btnGrade').style.display = 'inline-block';
  $('#btnFinish').style.display = 'inline-block';
}

function grade(){
  const nodes = Array.from(document.querySelectorAll('.question'));
  let correct=0, total=nodes.length;
  const details=[];
  nodes.forEach((node,idx)=>{
    const ans = parseInt(node.getAttribute('data-ans')||'0',10);
    const chosen = node.querySelector('input[type=radio]:checked');
    const picked = chosen ? parseInt(chosen.value,10) : 0;
    const sec = node.getAttribute('data-sec');
    const labels = optionLabels(sec);
    const qstem = node.querySelector('.q-stem').innerText;
    if(picked===ans) correct++;
    details.push({
      idx: idx+1,
      question: qstem,
      correct: ans ? labels[ans-1] : '',
      picked: picked ? labels[picked-1] : '',
      isCorrect: picked===ans
    });
  });
  const pct = total? Math.round(correct*100/total):0;
  $('#scoreBox').style.display='inline-block';
  $('#scoreBox').innerHTML = `النتيجة: <b>${correct}/${total}</b> (${pct}%) — ${new Date().toLocaleString('ar-EG')}`;
  $('#btnExportCSV').style.display='inline-block';
  $('#btnPrint').style.display='inline-block';
  $('#btnReview').style.display='inline-block';

  // save to localStorage
  const rec = {
    trainee: $('#trainee').value.trim(),
    ts: Date.now(),
    correct, total, pct,
    details
  };
  localStorage.setItem('tajweed:last_result', JSON.stringify(rec));
  // also push to history
  const hist = JSON.parse(localStorage.getItem('tajweed:history')||'[]');
  hist.push(rec);
  localStorage.setItem('tajweed:history', JSON.stringify(hist));
}

function toCSV(rec){
  const rows = [['الاسم','التاريخ','المجموع','الصحيح','النسبة'],[rec.trainee,new Date(rec.ts).toLocaleString('ar-EG'),rec.total,rec.correct,rec.pct],[],['#','السؤال','إجابتك','الصحيح','صواب؟']];
  rec.details.forEach(d=>rows.push([d.idx, d.question.replace(/\n/g,' '), d.picked, d.correct, d.isCorrect?'✔':'✘']));
  return rows.map(r=>r.map(c=>`"${(c||'').toString().replace(/"/g,'""')}"`).join(',')).join('\n');
}

function download(filename, content, type='text/csv'){
  const blob = new Blob([content], {type});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  URL.revokeObjectURL(a.href);
}

async function main(){
  $('#totalRange').addEventListener('input', e=>$('#totalLabel').innerHTML = `حدد عدد أسئلة الاختبار: <b>${e.target.value}</b>`);
  $('#btnShort').addEventListener('click', ()=>start(false));
  $('#btnFull').addEventListener('click', ()=>start(true));
  $('#btnFinish').addEventListener('click', grade);
  $('#btnGrade').addEventListener('click', grade);
  $('#btnExportCSV').addEventListener('click', ()=>{
    const rec = JSON.parse(localStorage.getItem('tajweed:last_result')||'null');
    if(rec) download(`tajweed_result_${rec.pct}pct.csv`, toCSV(rec));
  });
  $('#btnPrint').addEventListener('click', ()=>window.print());

  $('#loadMeta').textContent='جاري تحميل بنك الأسئلة…';
  const res = await fetch(bankUrl);
  BANK = await res.json();
  const count = Object.values(BANK.sections).reduce((acc,sec)=>acc+Object.values(sec.parts).reduce((a,b)=>a+b.length,0),0);
  $('#loadMeta').innerHTML = `تم التحميل: <b>${count}</b> سؤالًا`;
}
async function start(isFull){
  const secKey = $('#section').value;
  const total = isFull ? parseInt($('#totalRange').value,10) : 5;
  const pool = secKey ? flattenSection(secKey) : [];
  const list = pickN(pool, total);
  renderQuiz(list, secKey);
}

document.addEventListener('DOMContentLoaded', main);
</script>
</body>
</html>
