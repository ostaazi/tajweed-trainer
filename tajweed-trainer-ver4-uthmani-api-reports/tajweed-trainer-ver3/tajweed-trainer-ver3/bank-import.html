<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>استيراد بنك الأسئلة → tajweed_bank.js</title>
<link rel="stylesheet" href="styles.css" />
<style>
textarea{width:100%;min-height:240px;padding:10px;border:1px solid #ddd;border-radius:8px}
.kv{display:grid;grid-template-columns:160px 1fr;gap:8px;align-items:center}
pre{white-space:pre-wrap}
.badge{display:inline-block;background:#f0f0f0;border:1px solid #ddd;border-radius:999px;padding:2px 8px;margin:0 4px}
</style>
</head>
<body class="container">
  <h1>استيراد بنك الأسئلة</h1>
  <p class="muted">انسخ نص بنك الأسئلة من الملف (Word) والصقه هنا. ثم اضغط «تحليل»، وبعدها «تنزيل tajweed_bank.js». كل المعالجة تتم محليًا داخل متصفحك.</p>

  <div class="card">
    <div class="kv">
      <label>النون الساكنة والتنوين</label>
      <textarea id="noon_tanween"></textarea>
      <label>الميم الساكنة</label>
      <textarea id="meem_sakinah"></textarea>
      <label>أحكام المدود</label>
      <textarea id="madd"></textarea>
    </div>
    <div class="row">
      <button id="analyzeBtn" type="button">تحليل</button>
      <button id="downloadBtn" type="button" disabled>تنزيل tajweed_bank.js</button>
    </div>
    <pre id="out" class="console" style="display:none"></pre>
  </div>

<script>
function parseSection(text){
  if (!text) return [];
  const lines = text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  const qs = [];
  let i=0;
  while (i<lines.length){
    const l = lines[i];
    if (/[؟?]$/.test(l) || /^س(?:ؤال)?/.test(l) || /^\d+[)\.\-]/.test(l)){
      const qtext = l.replace(/^س(?:ؤال)?\s*[:\-]?\s*/,'').replace(/^\d+[)\.\-]\s*/,'');
      i++;
      const opts = [];
      while (i<lines.length){
        const m = lines[i].match(/^[\(\[]?([أابجده])[\)\]]\s*(.*)/);
        if (m){ opts.push(m[2].trim()); i++; continue; }
        if (/^[-–]\s+/.test(lines[i])){ opts.push(lines[i].replace(/^[-–]\s+/,'').trim()); i++; continue; }
        break;
      }
      if (opts.length>=2){
        qs.push({ text:qtext, options:opts });
      }
      continue;
    }
    i++;
  }
  // Answer key
  const t = text.replace(/،/g, ',').replace(/؛/g, ';');
  const pairs = [...t.matchAll(/(\d{1,3})\s*[-:)\.،,;]\s*([أابجده])/g)];
  const map = {};
  const toIndex = c => ({'أ':0,'ا':0,'ب':1,'ج':2,'د':3,'ه':3}[c]);
  for (const m of pairs){
    const num = parseInt(m[1],10)-1;
    const idx = toIndex(m[2]);
    if (!isNaN(num) && idx!=null) map[num] = idx;
  }
  qs.forEach((q,idx)=>{ if (map[idx]!=null && map[idx] < q.options.length) q.answer = map[idx]; });
  return qs;
}

let BANK = { noon_tanween:[], meem_sakinah:[], madd:[] };

document.getElementById('analyzeBtn').onclick = () => {
  BANK.noon_tanween = parseSection(document.getElementById('noon_tanween').value);
  BANK.meem_sakinah = parseSection(document.getElementById('meem_sakinah').value);
  BANK.madd         = parseSection(document.getElementById('madd').value);
  const out = document.getElementById('out');
  out.style.display = 'block';
  out.textContent = JSON.stringify(BANK, null, 2);
  document.getElementById('downloadBtn').disabled = false;
};

document.getElementById('downloadBtn').onclick = () => {
  const js = "window.TAJWEED_BANK = " + JSON.stringify(BANK, null, 2) + ";\n";
  const blob = new Blob([js], {type:'text/javascript'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'tajweed_bank.js';
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 500);
};
</script>
</body>
</html>
