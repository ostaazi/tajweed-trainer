<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta http-equiv="Content-Security-Policy" content="font-src 'self' data:;">
  <link rel="preload" href="./fonts/hafs.woff2" as="font" type="font/woff2" crossorigin>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>التجويد - الاختبار</title>

  <style>
    @font-face{
      font-family: 'UthmanicHafs';
      src: url('./fonts/hafs.woff2') format('woff2'), url('./fonts/KFGQPC_Uthmanic_Script_HAFS_Regular.otf') format('opentype');
      font-display: swap;
    }
    :root{ --ink:#0f172a; --muted:#64748b; --ring:#e2e8f0; --violet:#7B1FA2; }
    html,body{background:#fff;margin:0;padding:0;font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Noto Naskh Arabic', 'Amiri', serif;color:var(--ink)}
    .wrap{max-width:980px;margin:24px auto;padding:16px}
    h1{margin:0 0 12px 0;font-size:22px}
    .muted{color:var(--muted)}
    .btn{padding:10px 16px;border-radius:10px;border:1px solid var(--ring);background:#111;color:#fff;cursor:pointer}
    .btn.secondary{background:#4F46E5} .btn.info{background:#0ea5e9} .btn.danger{background:#dc2626}
    #list .q h4{margin:0 0 8px 0}
    #list label{display:block;border:1px solid var(--ring);border-radius:10px;padding:8px 10px;margin:6px 0;cursor:pointer}

    .ayah{ font-family:'UthmanicHafs','KFGQPC Uthman Taha Naskh','Noto Naskh Arabic',serif; font-size:1.5rem; line-height:2.3rem; text-align:center; }
    .target-word{ color: var(--violet); font-weight:700; background:rgba(123,31,162,.08); border-radius:4px; padding:0 3px; }

    .swatch{width:12px;height:12px;border-radius:3px;display:inline-block}
    .swatch-noon{ background: linear-gradient(to bottom, #d8ecff, #b5dcff); }
    .swatch-meem{ background: linear-gradient(to bottom, #f1d8ff, #e3b5ff); }
    .swatch-madd{ background: linear-gradient(to bottom, #fff2dc, #ffe2b5); }

    #triBar{position:relative;width:100%;height:26px;border-radius:999px;outline:1px solid var(--ring);user-select:none;margin-top:6px}
    #triBar .seg{position:absolute;inset-block:0;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:12px;color:#3b3b3b}
    #triBar .seg-noon{background:linear-gradient(to bottom,#e9f5ff,#cfe8ff)}
    #triBar .seg-meem{background:linear-gradient(to bottom,#f5e4ff,#e8c8ff)}
    #triBar .seg-madd{background:linear-gradient(to bottom,#fff6e8,#ffe8c6)}
    #triBar .pct{pointer-events:none}
    #triBar .handle{position:absolute;top:-6px;width:14px;height:38px;border-radius:6px;background:#0ea5e9;cursor:ew-resize;box-shadow:0 0 0 2px #fff}
    .triHelp{color:var(--muted);font-size:12px;margin:6px 2px 10px}

    #resultsPage{display:none}
    #reviewPage{display:none}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid var(--ring);padding:8px;text-align:right;vertical-align:top}
    th{background:#f8fafc}
    .pill{display:inline-block;padding:.15rem .45rem;border-radius:999px;background:#f1f5f9;color:#0f172a;font-size:.78rem}
    @media print{
      #btnBackToExam, #btnExportCSV, #btnExportHistoryCSV, #btnExportHistoryJSON, #btnPrint,
      #btnReviewMode, #btnBackFromReview, #btnPrev, #btnNext, #btnRemedial, #btnShowRule { display:none !important; }
    }
  
  :root{
    --ui-font: 'Cairo', system-ui, -apple-system, 'Segoe UI', Roboto, 'Noto Kufi Arabic', Tahoma, Arial, sans-serif;
    --bg: #ffffff;
    --fg: #111111;
    --ring:#d1d5db;
    --muted:#6b7280;
    --btn:#111111; --btn-fg:#ffffff;
    --accent:#0ea5e9;
  }
  body{ font-family: var(--ui-font); background:var(--bg); color:var(--fg); }
  body.dark{ --bg:#0b0b0e; --fg:#f3f4f6; --ring:#374151; --muted:#9ca3af; --btn:#111827; --btn-fg:#f9fafb; --accent:#38bdf8; }
  .btn{ background:var(--btn); color:var(--btn-fg); }
  .btn.info{ background:var(--accent); color:#fff; }
  .ayah{ font-family:'UthmanicHafs','KFGQPC Uthman Taha Naskh','Scheherazade',serif !important; }


  .btn-audio{ display:inline-flex; align-items:center; gap:.25em; font-size:.9em; padding:.15em .45em; border-radius:6px; background:var(--accent); color:#fff; margin-inline-start:.5em; }
  .btn-audio[disabled]{ opacity:.6; cursor:not-allowed; }


  .ayah-audio{ display:inline-flex; align-items:center; gap:.4em; margin-inline-start:.5em; }
  .btn-audio, .btn-audio-stop{ display:inline-flex; align-items:center; gap:.25em; font-size:.9em; padding:.15em .5em; border-radius:6px; background:var(--accent); color:#fff; }
  .btn-audio-stop{ background:#ef4444; }
  .btn-audio[disabled], .btn-audio-stop[disabled]{ opacity:.6; cursor:not-allowed; }
  .audio-bar{ width:120px; height:6px; border-radius:999px; background:rgba(0,0,0,.1); overflow:hidden; }
  body.dark .audio-bar{ background:rgba(255,255,255,.15); }
  .audio-bar > .fill{ height:100%; width:0%; background:#22c55e; }


  .audio-time{ font-size:.85em; color:var(--muted); min-width:72px; text-align:center; direction:ltr; }
  .audio-loop{ display:inline-flex; align-items:center; gap:.25em; font-size:.85em; color:var(--muted); user-select:none; }
  .audio-loop input{ transform: scale(1.05); }


  .audio-vol{ display:inline-flex; align-items:center; gap:.4em; margin-inline-start:.5em; }
  .audio-vol input[type="range"]{ width:110px; height:4px; border-radius:999px; background:transparent; }
  .audio-vol .vol-pct{ font-size:.85em; color:var(--muted); min-width:34px; text-align:start; }
  /* Toasts */
  #toastHost{ position:fixed; inset-inline-end:16px; inset-block-start:16px; display:flex; flex-direction:column; gap:8px; z-index:9999; }
  .toast{ min-width:240px; max-width:360px; background:#111; color:#fff; padding:.75em 1em; border-radius:10px; box-shadow:none; opacity:.98; }
  .toast.info{ background:#0ea5e9; }
  .toast.error{ background:#ef4444; }
  .toast.ok{ background:#16a34a; }
  body.dark .toast{ opacity:1; }


  /* Big result card */
  .result-card{
    background:#7c3aed; /* violet-600 */
    color:#fff;
    border-radius:16px;
    padding:18px 20px;
    margin:18px 0;
    box-shadow:none;
    border:2px solid rgba(255,255,255,.15);
  }
  .result-card .title{
    font-size:1.6rem; font-weight:800; letter-spacing:.2px; margin:0 0 6px 0;
  }
  .result-card .score{
    font-size:2.2rem; font-weight:900; line-height:1.2;
  }
  .result-card .meta{
    display:flex; gap:14px; flex-wrap:wrap; opacity:.95; margin-top:6px;
    font-size:1rem; font-weight:700;
  }
  .result-card .meta .pill{
    background:rgba(255,255,255,.15); padding:.25em .6em; border-radius:999px;
  }
  body.dark .result-card{ border-color:rgba(255,255,255,.25); }


  /* Question Card */
  .q-card{
    background: #fff;
    border: 1px solid var(--ring);
    border-radius: 16px;
    padding: 14px 14px;
    margin: 12px 0;
  }
  body.dark .q-card{
    background: #0f1115;
    border-color: #2a2f3a;
  }
  .q-card .q-head{ font-weight:800; font-size:1.15rem; margin-bottom:8px; }
  .q-card .q-stem{ font-size:1.05rem; line-height:1.8rem; margin:8px 0 10px; }
  .q-card .opts, .q-card .options, .q-card .choices{
    display:grid; gap:10px; grid-template-columns: repeat(auto-fit, minmax(160px,1fr));
    align-items:start;
  }
  .q-card .opts label, .q-card .options label, .q-card .choices label{
    display:flex; gap:.5em; align-items:flex-start; padding:.6em .75em;
    border:1px solid var(--ring); border-radius:12px; background:transparent;
    cursor:pointer;
  }
  .q-card .opts input[type="radio"]{ transform: scale(1.1); margin-top:.2em; }
  .q-card .ayah{ display:block; margin-top:6px; }
  .q-card .ayah-audio{ display:flex; gap:.5em; margin-top:6px; }


  /* --- Responsive Layout --- */
  :root{
    --container-w: 1100px;
    --pad: 14px;
  }
  main, .container, #app{
    max-width: var(--container-w);
    margin-inline: auto;
    padding-inline: var(--pad);
    width: 100%;
    box-sizing: border-box;
  }
  /* Buttons + toolbar wrap gracefully */
  #topToolbar{
    flex-wrap: wrap;
    row-gap: 8px;
    overflow-x: auto;
    padding-bottom: 4px;
  }
  #topToolbar .btn, #topToolbar label.tgl{
    flex: 0 0 auto;
  }
  /* Question card spacing on mobile */
  @media (max-width: 1024px){
    :root{ --pad: 12px; }
    .q-card{ padding: 12px; border-radius: 14px; }
    .result-card{ border-radius: 14px; }
  }
  @media (max-width: 768px){
    :root{ --pad: 10px; }
    h1{ font-size: 1.35rem; }
    .q-card .q-head{ font-size: 1.05rem; }
    .q-card .q-stem{ font-size: 1rem; line-height: 1.7rem; }
    .btn{ padding: .55em .8em; border-radius: 12px; }
    .ayah-audio{ flex-wrap: wrap; }
    .audio-bar{ width: 100px; }
    .audio-time{ min-width: 66px; }
  }
  @media (max-width: 560px){
    h1{ font-size: 1.2rem; }
    .btn{ padding: .5em .7em; }
    .q-card{ padding: 10px; }
    .q-card .opts, .q-card .options, .q-card .choices{
      grid-template-columns: 1fr; /* single column options for small screens */
    }
    .audio-bar{ width: 88px; }
    .audio-vol input[type="range"]{ width: 100px; }
    .result-card .title{ font-size: 1.3rem; }
    .result-card .score{ font-size: 1.8rem; }
    .result-card .meta{ font-size: .95rem; }
  }
  /* Touch target size improvements */
  .q-card .opts input[type="radio"]{ transform: scale(1.2); }
  .q-card .opts label{ min-height: 40px; }
  /* Ensure RTL padding integrity on narrow widths */
  body{ word-wrap: break-word; overflow-wrap: anywhere; }


  /* --- Sidebar Drawer (RTL-friendly on inline-end) --- */
  #sidebarDrawer{
    position: fixed;
    inset-block: 0;
    inset-inline-end: 0; /* right in RTL */
    width: min(86vw, 340px);
    background: var(--bg);
    color: var(--fg);
    border-inline-start: 1px solid var(--ring);
    transform: translateX(100%);
    transition: transform .25s ease;
    z-index: 1000;
    display: flex; flex-direction: column;
  }
  #sidebarDrawer.open{ transform: translateX(0); }
  #sidebarOverlay{
    position: fixed; inset: 0;
    background: rgba(0,0,0,.28);
    opacity: 0; pointer-events: none;
    transition: opacity .2s ease;
    z-index: 999;
  }
  #sidebarOverlay.show{ opacity: 1; pointer-events: auto; }

  .sd-head{ display:flex; align-items:center; justify-content:space-between; padding:12px; border-bottom:1px solid var(--ring); }
  .sd-title{ font-weight:800; font-size:1.1rem; }
  .sd-content{ padding:12px; display:flex; flex-direction:column; gap:10px; overflow:auto; }
  .sd-foot{ margin-top:auto; padding:12px; border-top:1px solid var(--ring); }
  .btn.sd-close{ background:#ef4444; }

  /* Settings modal */
  #settingsModal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:1100; }
  #settingsModal.show{ display:flex; }
  #settingsModal::before{ content:''; position:absolute; inset:0; background:rgba(0,0,0,.35); }
  #settingsModal .sm-body{
    position:relative; background:var(--bg); color:var(--fg);
    border:1px solid var(--ring); border-radius:14px; padding:16px; width:min(92vw,560px);
    z-index:1; display:flex; flex-direction:column; gap:10px;
  }
  .sm-title{ font-weight:800; font-size:1.2rem; }
  .sm-desc{ color:var(--muted); margin:0; }
  .sm-form{ display:grid; gap:8px; grid-template-columns: repeat(auto-fit, minmax(180px,1fr)); padding-block:4px; }
  .sm-actions{ display:flex; gap:8px; justify-content:flex-start; }

  /* Wrappers for movable controls */
  .ctl-wrap{ display:flex; align-items:center; gap:8px; }
  #sidebarContent .ctl-wrap{ padding:8px; border:1px solid var(--ring); border-radius:12px; }

  /* Ensure toolbar remains tidy when items move out */
  #topToolbar{ gap:8px; }


  .sd-sec{ display:flex; flex-direction:column; gap:8px; margin-bottom:12px; }
  .sd-sec .sd-label{ font-weight:800; font-size:.95rem; color:var(--muted); padding-inline:2px; }
  #sidebarContent .ctl-wrap{ margin-inline:2px; }


  .sm-tabs{ display:flex; gap:6px; margin-bottom:6px; }
  .sm-tab{ background:var(--btn); color:var(--btn-fg); border:none; border-radius:10px; padding:.4em .7em; cursor:pointer; }
  .sm-tab.active{ background:var(--accent); color:#fff; }
  .sm-section{ display:none; }
  .sm-section.show{ display:block; }
  .sm-group{ border:1px dashed var(--ring); border-radius:10px; padding:10px; margin:8px 0; }
  .sm-group .title{ font-weight:800; margin-bottom:6px; }


  body.audio-hidden .ayah-audio, body.audio-hidden .btn-audio, body.audio-hidden .btn-audio-stop, 
  body.audio-hidden .audio-bar, body.audio-hidden .audio-time, body.audio-hidden .audio-vol, 
  body.audio-hidden .audio-loop { display:none !important; }


  #detailsPanel{ margin-top:12px; border:1px solid var(--ring); border-radius:12px; padding:12px; display:none; background:rgba(124,58,237,.06); }
  #detailsPanel.show{ display:block; }
  .det-row{ border-bottom:1px dashed var(--ring); padding:8px 0; }
  .det-row:last-child{ border-bottom:none; }
  .det-q{ font-weight:700; }
  .det-rule{ color:var(--muted); }
  .det-ans{ display:flex; gap:8px; flex-wrap:wrap; margin-top:4px; }
  .det-ans .ok{ color:#16a34a; font-weight:800; }
  .det-ans .bad{ color:#ef4444; font-weight:800; }
  .det-actions{ display:flex; gap:8px; margin-top:8px; }


  #reportsModal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:1200; }
  #reportsModal.show{ display:flex; }
  #reportsModal::before{ content:''; position:absolute; inset:0; background:rgba(0,0,0,.35); }
  #reportsModal .rp-body{ position:relative; background:var(--bg); color:var(--fg); border:1px solid var(--ring); border-radius:14px; padding:16px; width:min(94vw,880px); z-index:1; display:flex; flex-direction:column; gap:10px; }
  .rp-title{ font-weight:800; font-size:1.2rem; }
  .rp-controls{ display:flex; gap:8px; flex-wrap:wrap; }
  .rp-content{ display:grid; gap:10px; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); }
  .rp-card{ border:1px solid var(--ring); border-radius:12px; padding:10px; }
  .rp-card .k{ font-size:.9rem; color:var(--muted); }
  .rp-card .v{ font-size:1.3rem; font-weight:900; }


  #shortQuizModal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:1300; }
  #shortQuizModal.show{ display:flex; }
  #shortQuizModal::before{ content:''; position:absolute; inset:0; background:rgba(0,0,0,.35); }
  .smq-body{ position:relative; background:var(--bg); color:var(--fg); border:1px solid var(--ring); border-radius:14px; padding:16px; width:min(92vw,520px); z-index:1; display:flex; flex-direction:column; gap:10px; }
  .smq-title{ font-weight:800; font-size:1.1rem; }
  .smq-controls{ display:grid; grid-template-columns:1fr 1fr; gap:8px; }
  .smq-controls label{ display:flex; gap:.5em; align-items:center; justify-content:space-between; }
  .smq-controls select{ padding:.35em .6em; border:1px solid var(--ring); border-radius:10px; }
  .smq-actions{ display:flex; gap:8px; }

</style>
<style id="tajweedy-api-toggles">
.toggles { display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin-top:6px; }
.tgl { display:inline-flex; align-items:center; gap:6px; background:#f5f7fa; border:1px solid #e5e7eb; padding:6px 10px; border-radius:10px; }
html.dark .tgl { background:#0f172a; border-color:#233044; }
.ayah      { font-family: 'KFGQPCUthmanicHAFS','Noto Naskh Arabic',serif; line-height: 2; }
.ayah-meta { color:#6b7280; font-size:.9rem; margin-top:4px; }
.ayah-target{ color:#15803d !important; font-weight:800; font-size:1.22em; background:#e6f4ea; border-radius:6px; padding:0 .25em; }
</style>
</head>
<body>
<main id="app">
  <div class="wrap" id="examPage">
    <h1>إعداد الاختبار</h1>

    <div id="topToolbar"
      ><div id="ctl_Trainee" class="ctl-wrap"><label style="font-weight:700;min-width:84px">المتدرّب:</label><input id="traineeId" type="text" placeholder="معرّف/اسم" style="padding:.35em .6em;border:1px solid var(--ring);border-radius:10px"></div>
      ><button id="btnMenu" class="btn" title="القائمة">☰ القائمة</button> style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:10px 0">
      <button id="btnAyahMeta" class="btn info">إظهار اسم السورة ورقم الآية</button>
      <label class="tgl" style="display:flex;gap:.5em;align-items:center">
        <input type="checkbox" id="tglApi" checked> استخدام نصّ الآية من API
      </label>
      <button id="btnDark" class="btn" title="الوضع الداكن">الوضع الداكن</button>
    
      <label class="tgl" style="display:flex;gap:.5em;align-items:center">
        القارئ:
        <select id="reciterSelect" style="padding:.35em .5em;border:1px solid var(--ring);border-radius:8px">
          <option value="2" selected>مشاري العفاسي</option>
          <option value="7">عبد الباسط (مجود)</option>
          <option value="3">الحصري (حفص)</option>
          <option value="10">السديس</option>
        </select>
      </label>

    </div>


    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:12px">
      <input id="studentName" type="text" placeholder="اسم المتدرّب" style="padding:10px;border:1px solid var(--ring);border-radius:10px">
      <select id="sectionSelect">
        <option value="noon">النون الساكنة والتنوين</option>
        <option value="meem">الميم الساكنة</option>
        <option value="madd">أحكام المدود</option>
      </select>
      <button id="btnShort" class="btn">بدء اختبار قصير (٥ أسئلة للقسم المحدد)</button>
      <button id="btnResume" class="btn" style="display:none;margin-inline-start:10px">استئناف</button>
    </div>

    <div id="controls" class="muted" style="margin-bottom:10px">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
        <label for="totalRange" style="font-weight:600">حدِّد عدد أسئلة الاختبار</label>
        <span><strong id="sumTarget">20</strong></span>
      </div>
      <input id="totalRange" type="range" min="5" max="100" step="1" value="20" style="width:100%">
      <input id="totalQ" type="hidden" value="20">
    </div>

    <div id="triLegend" style="display:flex;gap:12px;align-items:center;margin:10px 0 6px">
      <div style="display:flex;align-items:center;gap:6px"><span class="swatch swatch-noon"></span><span>النون الساكنة والتنوين</span></div>
      <div style="display:flex;align-items:center;gap:6px"><span class="swatch swatch-meem"></span><span>الميم الساكنة</span></div>
      <div style="display:flex;align-items:center;gap:6px"><span class="swatch swatch-madd"></span><span>أحكام المدود</span></div>
    </div>

    <div id="triWrap">
      <div id="triBar" aria-label="توزيع الإجمالي على الأقسام" title="اسحب الفواصل لتعديل النِّسب" dir="ltr">
        <div class="seg seg-noon"><span class="pct" id="pctNoon">33%</span></div>
        <div class="seg seg-meem"><span class="pct" id="pctMeem">33%</span></div>
        <div class="seg seg-madd"><span class="pct" id="pctMadd">34%</span></div>
        <div class="handle" id="h1"></div>
        <div class="handle" id="h2"></div>
      </div>
      <div class="triHelp">انقر أو اسحب الفواصل لتبديل العرض بين % وعدد الأسئلة.</div>
    </div>

    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:12px 0">
      <button id="btnComprehensive" class="btn secondary">بدء اختبار شامل
</button><!-- Tajweedy: API toggles -->
<div class="toggles" dir="rtl">
  
<button id="btnFinish" class="btn danger" style="display:none" style="display:none">إنهاء الاختبار</button>
      <button id="btnShowDetails" class="btn info" style="display:none">إظهار التفاصيل</button>
      <span id="diag" class="muted"></span>
      <span id="scoreSummary" class="pill" style="display:none"></span>
    </div>

    <div id="list"></div>
  </div>

  <div class="wrap" id="resultsPage">
    <h1>نتيجة الاختبار</h1>
    <p class="muted">
      المتدرّب: <strong id="resStudent"></strong> —
      الدرجة: <strong id="resScore"></strong>
    </p>
    <div style="display:flex;gap:10px;margin:12px 0;flex-wrap:wrap">
      <button id="btnBackToExam" class="btn">العودة للاختبار</button>
      <button id="btnExportCSV" class="btn info">حفظ النتائج CSV</button>
      <button id="btnExportHistoryCSV" class="btn info">تحميل CSV للسجل</button>
      <button id="btnExportHistoryJSON" class="btn info">تحميل JSON للسجل</button>
      <button id="btnPrint" class="btn">طباعة / حفظ PDF</button>
      <button id="btnReviewMode" class="btn">وضع المراجعة</button>
    </div>

    <div id="statsSummary" style="margin:14px 0"></div>
    <div id="subpartStats" style="margin:14px 0"></div>

    <div id="remedialBox" style="margin:14px 0; display:flex; gap:10px; align-items:center; flex-wrap:wrap">
      <label class="muted">تدريب علاجي من أخطائي:</label>
      <input id="remedialCount" type="number" min="1" value="5" style="width:80px;padding:8px;border:1px solid var(--ring);border-radius:10px">
      <label style="display:inline-flex;align-items:center;gap:6px">
        <input id="focusHard" type="checkbox" checked>
        <span class="muted">التركيز على الأسئلة الصعبة</span>
      </label>
      <button id="btnRemedial" class="btn">بدء تدريب علاجي</button>
    </div>
    <div id="remedialFilters" class="muted" style="display:flex;gap:16px;flex-wrap:wrap;align-items:flex-start">
      <div>
        <div style="font-weight:700;margin:6px 0 4px">الأقسام</div>
        <div id="filterSections" style="display:flex;gap:10px;flex-wrap:wrap"></div>
      </div>
      <div>
        <div style="font-weight:700;margin:6px 0 4px">الأجزاء الفرعية</div>
        <div id="filterParts" style="display:flex;gap:10px;flex-wrap:wrap;max-width:560px"></div>
      </div>
    </div>

    <div id="detailsWrap" style="margin-top:10px"></div>

    <div id="historyBox" style="margin:18px 0">
      <h2 style="margin:0 0 6px 0;font-size:18px">سجل الاختبارات</h2>
      <div id="historyTableWrap" class="muted">لا توجد بيانات بعد.</div>
    </div>
  </div>

  <div class="wrap" id="reviewPage" style="display:none">
    <h1>وضع المراجعة</h1>

    <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:10px 0">
      <label class="muted">القسم:</label>
      <select id="ruleSection"></select>
      <label class="muted">الجزء الفرعي:</label>
      <select id="rulePart"></select>
      <button id="btnShowRule" class="btn">عرض القاعدة</button>
      <button id="btnBackFromReview" class="btn">العودة للنتائج</button>
    </div>

    <div id="ruleText" class="muted" style="border:1px solid #e2e8f0;border-radius:12px;padding:12px;margin-bottom:12px;background:#fff"></div>

    <div id="reviewCard" style="border:1px solid #e2e8f0;border-radius:12px;padding:12px;background:#fff">
      <div id="reviewHeader" class="muted" style="margin-bottom:8px"></div>
      <div id="reviewStem" style="margin:8px 0"></div>
      <div id="reviewChoices" style="margin:6px 0"></div>
      <div id="reviewVerdict" style="margin:6px 0"></div>
    </div>

    <div style="display:flex;gap:10px;margin-top:12px">
      <button id="btnPrev" class="btn">السابق</button>
      <button id="btnNext" class="btn">التالي</button>
    </div>
  </div>

  <script src="quiz.js"></script>
<script id="tajweedy-api-js">
const KEY_USE_API  = 'tajweedy:useApi';
const KEY_SHOW_META= 'tajweedy:showMeta';
let USE_API   = JSON.parse(localStorage.getItem(KEY_USE_API)  ?? 'true');
let SHOW_META = JSON.parse(localStorage.getItem(KEY_SHOW_META)?? 'true');
function bindToggles(){
  const tApi  = document.getElementById('tglApi');
  const tMeta = document.getElementById('tglMeta');
  if(tApi){  tApi.checked = !!USE_API;   tApi.onchange  = ()=>{ USE_API=tApi.checked;   localStorage.setItem(KEY_USE_API, JSON.stringify(USE_API)); }; }
  if(tMeta){ tMeta.checked= !!SHOW_META; tMeta.onchange = ()=>{ SHOW_META=tMeta.checked; localStorage.setItem(KEY_SHOW_META,JSON.stringify(SHOW_META)); }; }
}
document.addEventListener('DOMContentLoaded', bindToggles);
async function fetchAyahUthmani(ref){
  const urlQuranCom = `https://api.quran.com/api/v4/verses/by_key/${encodeURIComponent(ref)}?fields=text_qpc_hafs,text_uthmani&words=false`;
  try{
    const r = await fetch(urlQuranCom, { cache:'no-cache' });
    if(r.ok){
      const j = await r.json();
      const verse = j?.verse?.text_qpc_hafs || j?.verse?.text_uthmani;
      if(verse) return verse;
    }
  }catch(e){}
  try{
    const urlCloud = `https://api.alquran.cloud/v1/ayah/${encodeURIComponent(ref)}/quran-uthmani`;
    const r2 = await fetch(urlCloud, { cache:'no-cache' });
    if(r2.ok){
      const j2 = await r2.json();
      const verse2 = j2?.data?.text;
      if(verse2) return verse2;
    }
  }catch(e){}
  return null;
}
function cacheGetAyah(ref){
  try{
    const raw = localStorage.getItem(`tajweedy:ayah:${ref}`);
    if(!raw) return null;
    const o = JSON.parse(raw);
    const T30=30*24*60*60*1000;
    if(Date.now()-(o.ts||0) > T30) return null;
    return o.text || null;
  }catch{ return null; }
}
function cacheSetAyah(ref, text){
  try{ localStorage.setItem(`tajweedy:ayah:${ref}`, JSON.stringify({text, ts:Date.now()})); }catch{}
}
function highlightTarget(ayahText, target){
  if(!target) return ayahText;
  const esc = target.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  const re = new RegExp(`(${esc})`, 'g');
  return ayahText.replace(re, '<span class="ayah-target">$1</span>');
}
const SURA_AR = ["","الفاتحة","البقرة","آل عمران","النساء","المائدة","الأنعام","الأعراف","الأنفال","التوبة","يونس","هود","يوسف","الرعد","إبراهيم","الحجر","النحل","الإسراء","الكهف","مريم","طه","الأنبياء","الحج","المؤمنون","النور","الفرقان","الشعراء","النمل","القصص","العنكبوت","الروم","لقمان","السجدة","الأحزاب","سبإ","فاطر","يس","الصافات","ص","الزمر","غافر","فصلت","الشورى","الزخرف","الدخان","الجاثية","الأحقاف","محمد","الفتح","الحجرات","ق","الذاريات","الطور","النجم","القمر","الرحمن","الواقعة","الحديد","المجادلة","الحشر","الممتحنة","الصف","الجمعة","المنافقون","التغابن","الطلاق","التحريم","الملك","القلم","الحاقة","المعارج","نوح","الجن","المزمل","المدثر","القيامة","الإنسان","المرسلات","النبإ","النازعات","عبس","التكوير","الانفطار","المطففين","الإنشقاق","البروج","الطارق","الأعلى","الغاشية","الفجر","البلد","الشمس","الليل","الضحى","الشرح","التين","العلق","القدر","البينة","الزلزلة","العاديات","القارعة","التكاثر","العصر","الهمزة","الفيل","قريش","الماعون","الكوثر","الكافرون","النصر","المسد","الإخلاص","الفلق","الناس"];
function formatRef(ref){
  const m = String(ref||'').match(/^(\\d+):(\\d+)$/);
  if(!m) return '';
  const s = Number(m[1]), v = Number(m[2]);
  return `[${SURA_AR[s]||s}: ${v}]`;
}
async function buildAyahHTML(q){
  const fallback = q.ayah || q.question || '';
  let text = fallback;
  if((window.USE_API ?? true) && q.ref){
    const cached = cacheGetAyah(q.ref);
    if(cached){ text = cached; }
    else{
      const fetched = await fetchAyahUthmani(q.ref);
      if(fetched){ text = fetched; cacheSetAyah(q.ref, fetched); }
    }
  }
  const ay = highlightTarget(text, q.target || null);
  const meta = ((window.SHOW_META ?? true) && q.ref) ? `<div class="ayah-meta">${formatRef(q.ref)}</div>` : '';
  return `<div class="ayah">قال تعالى: ${ay}</div>${meta}`;
}
</script>
  <div id="toastHost" aria-live="polite" aria-atomic="true"></div>
</main>

  <aside id="sidebarDrawer" aria-hidden="true">
    <div class="sd-head">
      <div class="sd-title">القائمة</div>
      <button id="btnCloseSidebar" class="btn sd-close" title="إغلاق">✕</button>
    </div>
    <nav id="sidebarContent" class="sd-content">
      
    <div class="sd-sec" id="sd-sec-actions"><div class="sd-label">الإجراءات</div><div class="ctl-wrap"><button id="btnOpenShortQuiz" class="btn">اختبار قصير (5 أسئلة)</button></div></div>
    <div class="sd-sec" id="sd-sec-view"><div class="sd-label">العرض</div></div>
    <div class="sd-sec" id="sd-sec-audio"><div class="sd-label">الصوت</div></div>
    <div class="sd-sec" id="sd-sec-results"><div class="sd-label">النتائج والتقارير</div><div class="ctl-wrap"><button id="btnResumeRemedial" class="btn">استئناف خطة علاجية</button></div></div>

    </nav>
    <div class="sd-foot">
      <button id="btnOpenSettings" class="btn info">إعدادات القائمة</button>
    </div>
  </aside>
  <div id="sidebarOverlay" tabindex="-1" aria-hidden="true"></div>


  <div id="settingsModal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="sm-body">
      <div class="sm-tabs" role="tablist">
        <button class="sm-tab" data-tab="layout">التخطيط</button>
        <button class="sm-tab" data-tab="appearance">المظهر</button>
        <button class="sm-tab" data-tab="audio">الصوت</button>
        <button class="sm-tab" data-tab="reports">التقارير</button>
      </div>
      <div class="sm-title">إعدادات توزيع الأزرار</div>
      <p class="sm-desc">اختر العناصر التي تريد نقلها إلى القائمة الجانبية. العناصر غير المحددة تبقى في الشريط العلوي.</p>
      <div id="sectionLayout" class="sm-section show"><div class="sm-group"><div class="title">موضع مُعرّف المتدرّب</div><label style="display:flex; gap:.5em; align-items:center">الموضع:<select id="traineePosSelect"><option value="toolbar">الشريط العلوي</option><option value="sidebar">القائمة الجانبية (العرض)</option></select></label></div><div class="sm-group"><div class="title">توزيع الأزرار (الشريط العلوي/القائمة الجانبية)</div><form id="settingsForm" class="sm-form"></form></div></div><div id="sectionAppearance" class="sm-section"><div class="sm-group"><div class="title">المظهر</div><label style="display:flex; gap:.5em; align-items:center">السِمة:<select id="themeSelect"><option value="auto">تلقائي</option><option value="light">فاتح</option><option value="dark">داكن</option></select></label></div></div><div id="sectionAudio" class="sm-section"><div class="sm-group"><div class="title">خيارات الصوت</div><label style="display:flex; gap:.5em; align-items:center"><input type="checkbox" id="chkShowAudio"> إظهار عناصر تشغيل الصوت داخل السؤال</label></div></div><div id="sectionReports" class="sm-section"><div class="sm-group"><div class="title">تحديث التقارير</div><label style="display:flex; gap:.5em; align-items:center">الفترة بالثواني:<input id="reportsRefreshSec" type="number" min="15" step="15" value="60" style="width:100px;padding:.35em .6em;border:1px solid var(--ring);border-radius:10px"></label></div><div class="sm-group"><div class="title">التقارير</div><label style="display:flex; gap:.5em; align-items:center"><input type="checkbox" id="chkShowReports"> تفعيل صفحة/نافذة التقارير</label></div></div>
        <!-- checkboxes injected by JS -->
      </form>
      <div class="sm-actions">
        <button id="btnSaveSettings" class="btn info">حفظ</button>
        <button id="btnCancelSettings" class="btn">إلغاء</button>
      </div>
    </div>
  </div>


  <div id="reportsModal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="rp-body">
      <div class="rp-title">التقارير والإحصاءات</div>
      <div class="rp-controls"><div id="rpFilters" style="display:flex;gap:8px;flex-wrap:wrap"><input id="fltTrainee" type="text" placeholder="معرّف المتدرّب" style="padding:.4em .6em;border:1px solid var(--ring);border-radius:10px"><input id="fltFrom" type="date" style="padding:.35em .6em;border:1px solid var(--ring);border-radius:10px"><input id="fltTo" type="date" style="padding:.35em .6em;border:1px solid var(--ring);border-radius:10px"><select id="fltTopic" style="padding:.35em .5em;border:1px solid var(--ring);border-radius:10px"><option value="">كل الموضوعات</option></select></div>
        <button id="btnRptRefresh" class="btn">تحديث</button>
        <button id="btnRptPrint" class="btn">طباعة / PDF</button>
        <button id="btnRptJSON" class="btn">تصدير JSON</button>
        <button id="btnRptCSV" class="btn">تصدير CSV</button>
      </div>
      <div id="rpContent" class="rp-content"></div>
      <div class="rp-actions">
        <button id="btnCloseReports" class="btn">إغلاق</button>
      </div>
    </div>
  </div>

  <div id="shortQuizModal" aria-hidden="true" role="dialog" aria-modal="true" style="display:none">
    <div class="smq-body">
      <div class="smq-title">اختيار الاختبار القصير</div>
      <div class="smq-controls">
        <label>القسم:
          <select id="sqSection"></select>
        </label>
        <label>الجزء الفرعي:
          <select id="sqPart"></select>
        </label>
      </div>
      <div class="smq-actions">
        <button id="btnStartShortQuiz" class="btn info">بدء الاختبار (5 أسئلة)</button>
        <button id="btnCancelShortQuiz" class="btn">إلغاء</button>
      </div>
    </div>
  </div>
</body>
</html>
