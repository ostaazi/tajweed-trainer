<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta http-equiv="Content-Security-Policy" content="font-src 'self' data:;">
  <link rel="preload" href="./fonts/hafs.woff2" as="font" type="font/woff2" crossorigin>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>التجويد - الاختبار</title>

  <style>
    @font-face{
      font-family: 'UthmanicHafs';
      src: url('./fonts/hafs.woff2') format('woff2'), url('./fonts/KFGQPC_Uthmanic_Script_HAFS_Regular.otf') format('opentype');
      font-display: swap;
    }
    :root{ --ink:#0f172a; --muted:#64748b; --ring:#e2e8f0; --violet:#7B1FA2; }
    html,body{background:#fff;margin:0;padding:0;font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Noto Naskh Arabic', 'Amiri', serif;color:var(--ink)}
    .wrap{max-width:980px;margin:24px auto;padding:16px}
    h1{margin:0 0 12px 0;font-size:22px}
    .muted{color:var(--muted)}
    .btn{padding:10px 16px;border-radius:10px;border:1px solid var(--ring);background:#111;color:#fff;cursor:pointer}
    .btn.secondary{background:#4F46E5} .btn.info{background:#0ea5e9} .btn.danger{background:#dc2626}
    #list .q h4{margin:0 0 8px 0}
    #list label{display:block;border:1px solid var(--ring);border-radius:10px;padding:8px 10px;margin:6px 0;cursor:pointer}

    .ayah{ font-family:'UthmanicHafs','KFGQPC Uthman Taha Naskh','Noto Naskh Arabic',serif; font-size:1.5rem; line-height:2.3rem; text-align:center; }
    .target-word{ color: var(--violet); font-weight:700; background:rgba(123,31,162,.08); border-radius:4px; padding:0 3px; }

    .swatch{width:12px;height:12px;border-radius:3px;display:inline-block}
    .swatch-noon{ background: linear-gradient(to bottom, #d8ecff, #b5dcff); }
    .swatch-meem{ background: linear-gradient(to bottom, #f1d8ff, #e3b5ff); }
    .swatch-madd{ background: linear-gradient(to bottom, #fff2dc, #ffe2b5); }

    #triBar{position:relative;width:100%;height:26px;border-radius:999px;outline:1px solid var(--ring);user-select:none;margin-top:6px}
    #triBar .seg{position:absolute;inset-block:0;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:12px;color:#3b3b3b}
    #triBar .seg-noon{background:linear-gradient(to bottom,#e9f5ff,#cfe8ff)}
    #triBar .seg-meem{background:linear-gradient(to bottom,#f5e4ff,#e8c8ff)}
    #triBar .seg-madd{background:linear-gradient(to bottom,#fff6e8,#ffe8c6)}
    #triBar .pct{pointer-events:none}
    #triBar .handle{position:absolute;top:-6px;width:14px;height:38px;border-radius:6px;background:#0ea5e9;cursor:ew-resize;box-shadow:0 0 0 2px #fff}
    .triHelp{color:var(--muted);font-size:12px;margin:6px 2px 10px}

    #resultsPage{display:none}
    #reviewPage{display:none}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid var(--ring);padding:8px;text-align:right;vertical-align:top}
    th{background:#f8fafc}
    .pill{display:inline-block;padding:.15rem .45rem;border-radius:999px;background:#f1f5f9;color:#0f172a;font-size:.78rem}
    @media print{
      #btnBackToExam, #btnExportCSV, #btnExportHistoryCSV, #btnExportHistoryJSON, #btnPrint,
      #btnReviewMode, #btnBackFromReview, #btnPrev, #btnNext, #btnRemedial, #btnShowRule { display:none !important; }
    }
  </style>
<style id="tajweedy-api-toggles">
.toggles { display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin-top:6px; }
.tgl { display:inline-flex; align-items:center; gap:6px; background:#f5f7fa; border:1px solid #e5e7eb; padding:6px 10px; border-radius:10px; }
html.dark .tgl { background:#0f172a; border-color:#233044; }
.ayah      { font-family: 'KFGQPCUthmanicHAFS','Noto Naskh Arabic',serif; line-height: 2; }
.ayah-meta { color:#6b7280; font-size:.9rem; margin-top:4px; }
.ayah-target{ color:#15803d !important; font-weight:800; font-size:1.22em; background:#e6f4ea; border-radius:6px; padding:0 .25em; }
</style>
<link rel="stylesheet" href="uthmani-font.css">
</head>
<body>
  <div class="wrap" id="examPage">
    <h1>إعداد الاختبار</h1>

    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:12px">
      <input id="studentName" type="text" placeholder="اسم المتدرّب" style="padding:10px;border:1px solid var(--ring);border-radius:10px">
      <select id="sectionSelect">
        <option value="noon">النون الساكنة والتنوين</option>
        <option value="meem">الميم الساكنة</option>
        <option value="madd">أحكام المدود</option>
      </select>
      <button id="btnShort" class="btn">بدء اختبار قصير (٥ أسئلة للقسم المحدد)</button>
      <button id="btnResume" class="btn" style="display:none;margin-inline-start:10px">استئناف</button>
    </div>

    <div id="controls" class="muted" style="margin-bottom:10px">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
        <label for="totalRange" style="font-weight:600">حدِّد عدد أسئلة الاختبار</label>
        <span><strong id="sumTarget">20</strong></span>
      </div>
      <input id="totalRange" type="range" min="5" max="100" step="1" value="20" style="width:100%">
      <input id="totalQ" type="hidden" value="20">
    </div>

    <div id="triLegend" style="display:flex;gap:12px;align-items:center;margin:10px 0 6px">
      <div style="display:flex;align-items:center;gap:6px"><span class="swatch swatch-noon"></span><span>النون الساكنة والتنوين</span></div>
      <div style="display:flex;align-items:center;gap:6px"><span class="swatch swatch-meem"></span><span>الميم الساكنة</span></div>
      <div style="display:flex;align-items:center;gap:6px"><span class="swatch swatch-madd"></span><span>أحكام المدود</span></div>
    </div>

    <div id="triWrap">
      <div id="triBar" aria-label="توزيع الإجمالي على الأقسام" title="اسحب الفواصل لتعديل النِّسب" dir="ltr">
        <div class="seg seg-noon"><span class="pct" id="pctNoon">33%</span></div>
        <div class="seg seg-meem"><span class="pct" id="pctMeem">33%</span></div>
        <div class="seg seg-madd"><span class="pct" id="pctMadd">34%</span></div>
        <div class="handle" id="h1"></div>
        <div class="handle" id="h2"></div>
      </div>
      <div class="triHelp">انقر أو اسحب الفواصل لتبديل العرض بين % وعدد الأسئلة.</div>
    </div>

    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:12px 0">
      <button id="btnComprehensive" class="btn secondary">بدء اختبار شامل
<!-- Tajweedy: API toggles -->
<div class="toggles" dir="rtl">
  <label class="tgl"><input type="checkbox" id="tglApi" checked> استخدام نصّ الآية من API</label>
  <label class="tgl"><input type="checkbox" id="tglMeta" checked> إظهار [اسم السورة: رقم الآية]</label>
</div></button>
      <button id="btnFinish" class="btn danger">إنهاء الاختبار</button>
      <button id="btnShowDetails" class="btn info" style="display:none">إظهار التفاصيل</button>
      <span id="diag" class="muted"></span>
      <span id="scoreSummary" class="pill" style="display:none"></span>
    </div>

    <div id="list"></div>
  </div>

  <div class="wrap" id="resultsPage">
    <h1>نتيجة الاختبار</h1>
    <p class="muted">
      المتدرّب: <strong id="resStudent"></strong> —
      الدرجة: <strong id="resScore"></strong>
    </p>
    <div style="display:flex;gap:10px;margin:12px 0;flex-wrap:wrap">
      <button id="btnBackToExam" class="btn">العودة للاختبار</button>
      <button id="btnExportCSV" class="btn info">حفظ النتائج CSV</button>
      <button id="btnExportHistoryCSV" class="btn info">تحميل CSV للسجل</button>
      <button id="btnExportHistoryJSON" class="btn info">تحميل JSON للسجل</button>
      <button id="btnPrint" class="btn">طباعة / حفظ PDF</button>
      <button id="btnReviewMode" class="btn">وضع المراجعة</button>
    </div>

    <div id="statsSummary" style="margin:14px 0"></div>
    <div id="subpartStats" style="margin:14px 0"></div>

    <div id="remedialBox" style="margin:14px 0; display:flex; gap:10px; align-items:center; flex-wrap:wrap">
      <label class="muted">تدريب علاجي من أخطائي:</label>
      <input id="remedialCount" type="number" min="1" value="5" style="width:80px;padding:8px;border:1px solid var(--ring);border-radius:10px">
      <label style="display:inline-flex;align-items:center;gap:6px">
        <input id="focusHard" type="checkbox" checked>
        <span class="muted">التركيز على الأسئلة الصعبة</span>
      </label>
      <button id="btnRemedial" class="btn">بدء تدريب علاجي</button>
    </div>
    <div id="remedialFilters" class="muted" style="display:flex;gap:16px;flex-wrap:wrap;align-items:flex-start">
      <div>
        <div style="font-weight:700;margin:6px 0 4px">الأقسام</div>
        <div id="filterSections" style="display:flex;gap:10px;flex-wrap:wrap"></div>
      </div>
      <div>
        <div style="font-weight:700;margin:6px 0 4px">الأجزاء الفرعية</div>
        <div id="filterParts" style="display:flex;gap:10px;flex-wrap:wrap;max-width:560px"></div>
      </div>
    </div>

    <div id="detailsWrap" style="margin-top:10px"></div>

    <div id="historyBox" style="margin:18px 0">
      <h2 style="margin:0 0 6px 0;font-size:18px">سجل الاختبارات</h2>
      <div id="historyTableWrap" class="muted">لا توجد بيانات بعد.</div>
    </div>
  </div>

  <div class="wrap" id="reviewPage" style="display:none">
    <h1>وضع المراجعة</h1>

    <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:10px 0">
      <label class="muted">القسم:</label>
      <select id="ruleSection"></select>
      <label class="muted">الجزء الفرعي:</label>
      <select id="rulePart"></select>
      <button id="btnShowRule" class="btn">عرض القاعدة</button>
      <button id="btnBackFromReview" class="btn">العودة للنتائج</button>
    </div>

    <div id="ruleText" class="muted" style="border:1px solid #e2e8f0;border-radius:12px;padding:12px;margin-bottom:12px;background:#fff"></div>

    <div id="reviewCard" style="border:1px solid #e2e8f0;border-radius:12px;padding:12px;background:#fff">
      <div id="reviewHeader" class="muted" style="margin-bottom:8px"></div>
      <div id="reviewStem" style="margin:8px 0"></div>
      <div id="reviewChoices" style="margin:6px 0"></div>
      <div id="reviewVerdict" style="margin:6px 0"></div>
    </div>

    <div style="display:flex;gap:10px;margin-top:12px">
      <button id="btnPrev" class="btn">السابق</button>
      <button id="btnNext" class="btn">التالي</button>
    </div>
  </div>

  <script src="quiz.js"></script>
<script id="tajweedy-api-js">
const KEY_USE_API  = 'tajweedy:useApi';
const KEY_SHOW_META= 'tajweedy:showMeta';
let USE_API   = JSON.parse(localStorage.getItem(KEY_USE_API)  ?? 'true');
let SHOW_META = JSON.parse(localStorage.getItem(KEY_SHOW_META)?? 'true');
function bindToggles(){
  const tApi  = document.getElementById('tglApi');
  const tMeta = document.getElementById('tglMeta');
  if(tApi){  tApi.checked = !!USE_API;   tApi.onchange  = ()=>{ USE_API=tApi.checked;   localStorage.setItem(KEY_USE_API, JSON.stringify(USE_API)); }; }
  if(tMeta){ tMeta.checked= !!SHOW_META; tMeta.onchange = ()=>{ SHOW_META=tMeta.checked; localStorage.setItem(KEY_SHOW_META,JSON.stringify(SHOW_META)); }; }
}
document.addEventListener('DOMContentLoaded', bindToggles);
async function fetchAyahUthmani(ref){
  const urlQuranCom = `https://api.quran.com/api/v4/verses/by_key/${encodeURIComponent(ref)}?fields=text_qpc_hafs,text_uthmani&words=false`;
  try{
    const r = await fetch(urlQuranCom, { cache:'no-cache' });
    if(r.ok){
      const j = await r.json();
      const verse = j?.verse?.text_qpc_hafs || j?.verse?.text_uthmani;
      if(verse) return verse;
    }
  }catch(e){}
  try{
    const urlCloud = `https://api.alquran.cloud/v1/ayah/${encodeURIComponent(ref)}/quran-uthmani`;
    const r2 = await fetch(urlCloud, { cache:'no-cache' });
    if(r2.ok){
      const j2 = await r2.json();
      const verse2 = j2?.data?.text;
      if(verse2) return verse2;
    }
  }catch(e){}
  return null;
}
function cacheGetAyah(ref){
  try{
    const raw = localStorage.getItem(`tajweedy:ayah:${ref}`);
    if(!raw) return null;
    const o = JSON.parse(raw);
    const T30=30*24*60*60*1000;
    if(Date.now()-(o.ts||0) > T30) return null;
    return o.text || null;
  }catch{ return null; }
}
function cacheSetAyah(ref, text){
  try{ localStorage.setItem(`tajweedy:ayah:${ref}`, JSON.stringify({text, ts:Date.now()})); }catch{}
}
function highlightTarget(ayahText, target){
  if(!target) return ayahText;
  const esc = target.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  const re = new RegExp(`(${esc})`, 'g');
  return ayahText.replace(re, '<span class="ayah-target">$1</span>');
}
const SURA_AR = ["","الفاتحة","البقرة","آل عمران","النساء","المائدة","الأنعام","الأعراف","الأنفال","التوبة","يونس","هود","يوسف","الرعد","إبراهيم","الحجر","النحل","الإسراء","الكهف","مريم","طه","الأنبياء","الحج","المؤمنون","النور","الفرقان","الشعراء","النمل","القصص","العنكبوت","الروم","لقمان","السجدة","الأحزاب","سبإ","فاطر","يس","الصافات","ص","الزمر","غافر","فصلت","الشورى","الزخرف","الدخان","الجاثية","الأحقاف","محمد","الفتح","الحجرات","ق","الذاريات","الطور","النجم","القمر","الرحمن","الواقعة","الحديد","المجادلة","الحشر","الممتحنة","الصف","الجمعة","المنافقون","التغابن","الطلاق","التحريم","الملك","القلم","الحاقة","المعارج","نوح","الجن","المزمل","المدثر","القيامة","الإنسان","المرسلات","النبإ","النازعات","عبس","التكوير","الانفطار","المطففين","الإنشقاق","البروج","الطارق","الأعلى","الغاشية","الفجر","البلد","الشمس","الليل","الضحى","الشرح","التين","العلق","القدر","البينة","الزلزلة","العاديات","القارعة","التكاثر","العصر","الهمزة","الفيل","قريش","الماعون","الكوثر","الكافرون","النصر","المسد","الإخلاص","الفلق","الناس"];
function formatRef(ref){
  const m = String(ref||'').match(/^(\\d+):(\\d+)$/);
  if(!m) return '';
  const s = Number(m[1]), v = Number(m[2]);
  return `[${SURA_AR[s]||s}: ${v}]`;
}
async function buildAyahHTML(q){
  const fallback = q.ayah || q.question || '';
  let text = fallback;
  if((window.USE_API ?? true) && q.ref){
    const cached = cacheGetAyah(q.ref);
    if(cached){ text = cached; }
    else{
      const fetched = await fetchAyahUthmani(q.ref);
      if(fetched){ text = fetched; cacheSetAyah(q.ref, fetched); }
    }
  }
  const ay = highlightTarget(text, q.target || null);
  const meta = ((window.SHOW_META ?? true) && q.ref) ? `<div class="ayah-meta">${formatRef(q.ref)}</div>` : '';
  return `<div class="ayah">قال تعالى: ${ay}</div>${meta}`;
}
</script>
  <script src="app.js"></script>
<script src="link-bank-patch.js"></script>
<script src="quiz.js"></script>

</body>
</html>
