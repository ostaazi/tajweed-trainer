<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Tajweedy — لوحة شاملة</title>
<link rel="stylesheet" href="styles.css"/>
<style>
.container{max-width:1000px;margin:24px auto;padding:0 16px}
.card{background:var(--tj-surface,#fff);border:1px solid var(--tj-border,#e5e7eb);border-radius:14px;padding:16px;margin:12px 0}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border:1px solid var(--tj-border,#e5e7eb);padding:8px;text-align:center;vertical-align:top}
canvas{width:100%;height:320px}
@media print {.no-print{display:none} body{background:#fff}}
</style>
</head>
<body>
<header class="container">
  <h1>📊 لوحة شاملة — Tajweedy</h1>
  <div class="muted">ملخص الإحصاءات والسجل. يمكنك الطباعة لحفظ PDF.</div>
</header>
<main class="container">
  <div class="card no-print">
    <button onclick="history.back()">⬅️ العودة</button>
    <button onclick="window.print()">🖨️ طباعة</button>
  </div>
  <section class="card">
    <h2>الأخطاء حسب الحكم</h2>
    <canvas id="bars"></canvas>
  </section>
  <section class="card">
    <h2>نسبة الصواب عبر الزمن</h2>
    <canvas id="line"></canvas>
  </section>
  <section class="card">
    <h2>السجل</h2>
    <table class="table" id="tbl"><thead><tr><th>#</th><th>التاريخ</th><th>المتدرّب</th><th>القسم</th><th>النتيجة</th></tr></thead><tbody></tbody></table>
  </section>
</main>
<script>
const map={noon_tanween:'النون الساكنة والتنوين',meem_sakinah:'الميم الساكنة',madd:'أحكام المدود',full:'اختبار شامل',custom:'مخصص'};
const data = JSON.parse(localStorage.getItem('tajweedy_progress_full')||'[]');

// bars
(function(){
  const cvs=document.getElementById('bars'); const ctx=cvs.getContext('2d');
  const W=cvs.width=cvs.clientWidth*2, H=cvs.height=320*2; ctx.scale(2,2);
  const counts={noon_tanween:0,meem_sakinah:0,madd:0};
  data.forEach(r=>{ if(r.sectionKey in counts){ counts[r.sectionKey]+= (r.total - r.correct); }});
  const keys=Object.keys(counts), vals=keys.map(k=>counts[k]);
  const max=Math.max(1, ...vals); const pad=40; const bw=60; const gap=40; const base=300;
  ctx.clearRect(0,0,cvs.clientWidth,320);
  ctx.font='12px sans-serif'; ctx.fillStyle='#333';
  keys.forEach((k,i)=>{
     const x=pad + i*(bw+gap); const h=(vals[i]/max)*240; const y=base-h;
     ctx.fillStyle='#e5f5ec'; ctx.fillRect(x,y,bw,h);
     ctx.strokeStyle='#0b6'; ctx.strokeRect(x,y,bw,h);
     ctx.fillStyle='#333'; ctx.fillText(map[k], x-10, base+16);
     ctx.fillText(vals[i], x+bw/2-4, y-6);
  });
})();
// line
(function(){
  const cvs=document.getElementById('line'); const ctx=cvs.getContext('2d');
  const W=cvs.width=cvs.clientWidth*2, H=cvs.height=320*2; ctx.scale(2,2);
  const pts = data.map(r=>({t:r.ts||Date.now(), p: (r.total? (r.correct/r.total*100):0)})).sort((a,b)=>a.t-b.t);
  ctx.clearRect(0,0,cvs.clientWidth,320); if(!pts.length){ ctx.fillText('لا توجد بيانات', 20, 30); return; }
  const minT=pts[0].t, maxT=pts[pts.length-1].t; const pad=40; const ww=cvs.clientWidth- pad*2, hh=260, base=300;
  ctx.strokeStyle='#ddd'; ctx.beginPath(); ctx.moveTo(pad,base-hh); ctx.lineTo(pad,base); ctx.lineTo(cvs.clientWidth-10,base); ctx.stroke();
  ctx.fillStyle='#333'; ctx.font='12px sans-serif'; for(let y=0;y<=5;y++){const val=y*20; const ypx=base - (val/100)*hh; ctx.fillText(val+'%', 8, ypx+4); ctx.strokeStyle='#f1f1f1'; ctx.beginPath(); ctx.moveTo(pad, ypx); ctx.lineTo(cvs.clientWidth-10, ypx); ctx.stroke();}
  ctx.strokeStyle='#0b6'; ctx.lineWidth=2; ctx.beginPath();
  pts.forEach((p,i)=>{ const x=pad + ((p.t-minT)/(Math.max(1,maxT-minT)))*ww; const y=base - (p.p/100)*hh; if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); ctx.fillRect(x-2,y-2,4,4); });
  ctx.stroke();
})();
// table
(function(){
  const tb=document.querySelector('#tbl tbody'); if(!data.length){ tb.innerHTML='<tr><td colspan=5>لا توجد محاولات.</td></tr>'; return; }
  data.forEach((r,i)=>{
    const tr=document.createElement('tr');
    const dt=new Date(r.ts||Date.now()).toLocaleString('ar-EG');
    tr.innerHTML=`<td>${i+1}</td><td>${dt}</td><td>${r.traineeName||''}</td><td>${map[r.sectionKey]||r.sectionKey}</td><td>${r.correct}/${r.total}</td>`;
    tb.appendChild(tr);
  });
})();
</script>
</body>
</html>