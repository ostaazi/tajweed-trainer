<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tajweed Trainer — Quiz (ver3 hotfix single-file)</title>

  <!-- يضبط قاعدة الروابط تلقائيًا لمسار الصفحة على GitHub Pages -->
  <base href="" id="__BASE__">
  <script>
    (function(){
      const base = location.pathname.replace(/[^/]+$/, ''); // ينتهي بـ '/'
      const b = document.getElementById('__BASE__'); if (b) b.setAttribute('href', base);
      window.__TT_BASE__ = base;
    })();
  </script>

  <style>
    :root{
      --bg:#ffffff; --fg:#111827; --muted:#6b7280; --primary:#2563eb; --primary-cta:#1d4ed8;
      --border:#e5e7eb; --chip:#f3f4f6; --danger:#ef4444; --ok:#16a34a; --card:#ffffff;
    }
    [data-theme="dark"]{
      --bg:#0b0f16; --fg:#e5e7eb; --muted:#94a3b8; --primary:#60a5fa; --primary-cta:#3b82f6;
      --border:#1f2937; --chip:#0f172a; --card:#0e1622;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.6 system-ui,Segoe UI,Roboto,"Noto Kufi Arabic","Cairo",Arial}
    .wrap{max-width:1100px;margin:24px auto;padding:16px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px}
    h1{font-size:20px;margin:0}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:16px}
    label{display:block;margin:6px 0 4px;font-weight:600}
    input[type="text"], select, input[type="number"]{
      width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;background:transparent;color:var(--fg)
    }
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1 1 260px}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{background:var(--chip);border:1px solid var(--border);padding:6px 10px;border-radius:999px;font-size:13px;display:inline-flex;align-items:center;gap:6px}
    .chip input{margin-inline-start:6px}
    .btn{appearance:none;border:1px solid var(--border);background:var(--primary);color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer}
    .btn.secondary{background:transparent;color:var(--fg)}
    .btn.danger{background:var(--danger);border-color:var(--danger)}
    .btn.ok{background:var(--ok);border-color:var(--ok)}
    .muted{color:var(--muted);font-size:13px}
    .grid{display:grid;gap:12px}
    .grid-2{grid-template-columns:repeat(auto-fit,minmax(280px,1fr))}
    .toggle{display:flex;align-items:center;gap:8px}
    .hr{height:1px;background:var(--border);margin:12px 0}
    .hidden{display:none !important}
    .q{border:1px solid var(--border);border-radius:10px;padding:12px;margin:8px 0}
    .q h4{margin:0 0 6px;font-size:16px}
    .answers{display:grid;gap:6px}
    .answers label{font-weight:500}
    .bar{height:8px;background:var(--chip);border-radius:999px;overflow:hidden}
    .bar > i{display:block;height:100%;background:var(--primary-cta);width:0%}
    canvas.sig{border:1px dashed var(--border);border-radius:10px;background:#fff}
    .footer-note{font-size:12px;color:var(--muted)}
  </style>
</head>
<body data-theme="light">
  <div class="wrap">
    <header>
      <h1>إعداد الاختبار</h1>
      <div class="toggle">
        <label for="darkMode">الوضع الداكن</label>
        <input id="darkMode" type="checkbox">
      </div>
    </header>

    <section class="card">
      <div class="row">
        <div class="col">
          <label>اسم/معرّف المتدرّب</label>
          <input id="learnerName" type="text" placeholder="اسمك هنا">
        </div>
        <div class="col">
          <label>القارئ</label>
          <select id="readerSelect">
            <option value="مشاري">مشاري العفاسي</option>
            <option value="الحصري">محمود خليل الحصري</option>
            <option value="منشاوي">محمد صديق المنشاوي</option>
          </select>
        </div>
        <div class="col">
          <label class="toggle">
            <input id="useAyahAPI" type="checkbox" />
            استخدام نصّ الآية من API (آمن التعطّل)
          </label>
        </div>
      </div>

      <div class="hr"></div>

      <div class="row">
        <div class="col">
          <label>حدِّد عدد أسئلة الاختبار</label>
          <input id="qCount" type="number" min="5" step="5" value="20">
          <p class="muted">لن تُمنح شهادة امتياز إذا كان العدد أقل من 20.</p>
        </div>
        <div class="col">
          <label>الأقسام</label>
          <div id="sectionChips" class="chips">
            <!-- يُملأ آليًا بعد التحميل -->
          </div>
          <p class="muted">انقر لتفعيل/تعطيل الأقسام. يمكنك السحب لتغيير العرض (لنسبة ظهور الأسئلة من كل قسم).</p>
        </div>
        <div class="col" style="align-self:end">
          <button id="quick5" class="btn secondary">اختبار قصير (5 أسئلة)</button>
        </div>
      </div>

      <div class="hr"></div>

      <div class="row">
        <div class="col">
          <button id="startQuiz" class="btn">بدء الاختبار</button>
        </div>
        <div class="col">
          <button id="showCertificates" class="btn secondary">الشهادات</button>
        </div>
        <div class="col">
          <button id="askPlan" class="btn secondary">استشِفْ خطة علاجية</button>
        </div>
      </div>
    </section>

    <section id="quizArea" class="card hidden">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h2 style="margin:0">الاختبار</h2>
        <div style="min-width:220px">
          <div class="bar"><i id="progressBar"></i></div>
          <div class="muted" id="progressText">0%</div>
        </div>
      </div>
      <div id="qList"></div>
      <div class="row" style="justify-content:space-between;margin-top:12px">
        <button id="submitQuiz" class="btn ok">إنهاء وتصحيح</button>
        <button id="backToSetup" class="btn secondary">عودة للإعدادات</button>
      </div>
    </section>

    <section id="resultArea" class="card hidden">
      <h2 style="margin-top:0">النتائج</h2>
      <p>الاسم: <b id="rName">-</b></p>
      <p>الدرجة: <b id="rScore">-</b></p>
      <p class="muted" id="rHonorNote"></p>
      <div class="hr"></div>

      <h3>التوقيع على الشهادة</h3>
      <div class="grid grid-2">
        <div>
          <label>رفع صورة توقيع</label>
          <input id="sigFile" type="file" accept="image/*">
          <img id="sigPreview" alt="Signature preview" style="display:block;max-width:100%;margin-top:8px;border:1px solid var(--border);border-radius:8px">
        </div>
        <div>
          <label>أو التوقيع الحر</label>
          <canvas id="sigPad" class="sig" width="500" height="180"></canvas>
          <div class="row" style="margin-top:8px">
            <button id="sigClear" class="btn secondary">مسح</button>
            <button id="useCanvasSig" class="btn">اعتماد التوقيع</button>
          </div>
        </div>
      </div>

      <div class="hr"></div>
      <button id="downloadCert" class="btn" disabled>تنزيل الشهادة (PNG)</button>
      <p class="footer-note">شهادة الامتياز تمنح فقط عند ≥ 90% ومع ≥ 20 سؤالًا.</p>
    </section>
  </div>

  <!-- بنك أسئلة محلي مضمّن كاحتياطي (يمكنك استبداله أو توسعته) -->
  <script type="application/json" id="local-bank">
  {
    "sections": {
      "النون الساكنة والتنوين": {
        "weight": 1,
        "questions": [
          {"id":"n1","text":"قال تعالى: ﴿مَنْ آمَنَ﴾ — ما الحكم؟","choices":["إظهار حلقي","إدغام بغنة","إدغام بغير غنة","إخفاء حقيقي"],"answer":0,"ayah":"من آمن","surah":"البقرة","ayah_no":62},
          {"id":"n2","text":"﴿سَمِيعٌ عَلِيمٌ﴾ — ما الحكم بين الكلمتين؟","choices":["إدغام بغنة","إظهار حلقي","إقلاب","إخفاء"],"answer":0}
        ]
      },
      "الميم الساكنة": {
        "weight": 1,
        "questions": [
          {"id":"m1","text":"﴿كَمْ بِكُمْ﴾ — ما الحكم؟","choices":["إقلاب","إظهار شفوي","إخفاء شفوي","إدغام شفوي"],"answer":2}
        ]
      },
      "أحكام المدود": {
        "weight": 1,
        "questions": [
          {"id":"md1","text":"﴿قَائِمَةٌ﴾ — ما نوع المد؟","choices":["مد طبيعي","مد متصل","مد منفصل","مد لازم"],"answer":0}
        ]
      }
    }
  }
  </script>

  <script defer>
    // ==================== دعم الوضع الداكن ====================
    const darkToggle = document.getElementById('darkMode');
    (function initTheme(){
      const saved = localStorage.getItem('tt_theme');
      if(saved){ document.body.setAttribute('data-theme', saved); darkToggle.checked = (saved === 'dark'); }
      darkToggle.addEventListener('change', ()=>{
        const theme = darkToggle.checked ? 'dark' : 'light';
        document.body.setAttribute('data-theme', theme);
        localStorage.setItem('tt_theme', theme);
      });
    })();

    // ==================== المتغيرات العامة ====================
    const MIN_FOR_HONOR = 20;
    let QUESTIONS = [];         // يحوي كل الأسئلة بعد الدمج
    let SECTIONS = [];          // أسماء الأقسام بعد التحميل
    let CURRENT = { total: 0, answers: {}, selected: [], score: 0 };

    // ==================== تحميل بنك الأسئلة (متين لبيئة gh-pages) ====================
    async function loadBank(){
      if (QUESTIONS.length) return;

      const BASE = (window.__TT_BASE__ || (new URL('.', location.href)).href);
      const pick = (...xs) => xs.filter(Boolean);

      const candidates = pick(
        `${BASE}questions_bank.json`,
        `${BASE}data/questions_bank.json`,
        `${BASE}data/quiz_bank.json`,
        // احتياطي عام (إن توفر)
        `https://ostaazi.github.io/tajweed-trainer/questions_bank.json`
      );

      let data = null, lastErr = null;
      for(const url of candidates){
        try{
          const res = await fetch(url, { cache:'no-cache' });
          if(!res.ok) { lastErr = new Error('HTTP '+res.status); continue; }
          data = await res.json();
          break;
        }catch(e){ lastErr = e; }
      }

      if(!data){
        try{
          const text = document.getElementById('local-bank').textContent;
          data = JSON.parse(text);
          console.warn('تم استخدام بنك الأسئلة المحلي المضمَّن داخل الملف (لفشل الجلب).');
        }catch(e){
          console.error('تعذر تحميل بنك الأسئلة:', lastErr || e);
          alert('تعذر تحميل بنك الأسئلة. راجع Console لمعرفة السبب.');
          return;
        }
      }

      // تطبيع البنية إلى مصفوفة أسئلة + قائمة أقسام
      const sections = data.sections ? data.sections : {};
      SECTIONS = Object.keys(sections);
      QUESTIONS = [];
      SECTIONS.forEach(name=>{
        const arr = sections[name]?.questions || [];
        arr.forEach(q=>QUESTIONS.push({...q, __section:name}));
      });
    }

    // ==================== Ayah API آمن التعطل ====================
    function canUseAyahAPI(){
      // ضع مفتاحك في window.__TAJWEEDY_API_KEY إن لزم — هنا نكتفي بالتأكد أن fetch موجود
      return typeof fetch === 'function';
    }
    async function safeFetchAyah(ref){
      // ref = {surah, ayah_no} أو أي مرجع لديك
      if(!document.getElementById('useAyahAPI').checked) return null;
      if(!canUseAyahAPI()) return null;
      try{
        // مثال تخيلي — استبدله بمصدر الآيات الفعلي لديك
        // هنا نُعيد null دائمًا لتفادي أعطال غير مقصودة
        return null;
      }catch(e){
        console.warn('تعذر جلب نصّ الآية من API. سيتم استخدام النص المحلي (إن وُجد).', e);
        return null;
      }
    }

    // ==================== توليد واجهة الأقسام ====================
    function renderSectionChips(){
      const host = document.getElementById('sectionChips');
      host.innerHTML = '';
      SECTIONS.forEach((name, idx)=>{
        const id = 'sec_'+idx;
        const el = document.createElement('label');
        el.className = 'chip';
        el.innerHTML = `<input type="checkbox" id="${id}" checked /> ${name}`;
        host.appendChild(el);
      });
    }
    function getEnabledSections(){
      const host = document.getElementById('sectionChips');
      const checks = [...host.querySelectorAll('input[type=checkbox]')];
      return checks.filter(x=>x.checked).map(x=>x.parentElement.textContent.trim());
    }

    // ==================== اختيار الأسئلة ====================
    function sampleQuestions(count, enabledSecs){
      const pool = QUESTIONS.filter(q => enabledSecs.includes(q.__section));
      // خلط بسيط
      for(let i=pool.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [pool[i],pool[j]]=[pool[j],pool[i]]; }
      return pool.slice(0, Math.max(1, Math.min(count, pool.length)));
    }

    // ==================== بناء عرض الأسئلة ====================
    async function renderQuiz(list){
      const host = document.getElementById('qList');
      host.innerHTML = '';
      let idx = 0;

      for(const q of list){
        const wrap = document.createElement('div');
        wrap.className = 'q';
        const title = document.createElement('h4');
        title.textContent = `س${++idx}: ${q.text}`;
        wrap.appendChild(title);

        // محاولة جلب نص الآية من API (إن فعّلت الخيار)
        const apiAyah = await safeFetchAyah({surah:q.surah, ayah_no:q.ayah_no});
        if(apiAyah || q.ayah){
          const p = document.createElement('p');
          p.className = 'muted';
          p.textContent = `النص: ${apiAyah || q.ayah || ''}${q.surah?` — (${q.surah}:${q.ayah_no||''})`:''}`;
          wrap.appendChild(p);
        }

        const ans = document.createElement('div');
        ans.className = 'answers';
        q.choices.forEach((c,i)=>{
          const id = `q_${q.id}_${i}`;
          const lab = document.createElement('label');
          lab.setAttribute('for', id);
          lab.innerHTML = `<input type="radio" name="q_${q.id}" id="${id}" value="${i}"> ${c}`;
          ans.appendChild(lab);
        });
        wrap.appendChild(ans);
        host.appendChild(wrap);
      }

      // تقدّم
      const bar = document.getElementById('progressBar');
      const txt = document.getElementById('progressText');
      let answered = 0;
      host.addEventListener('change', (e)=>{
        if(e.target.name?.startsWith('q_')){
          const name = e.target.name;
          CURRENT.answers[name] = true;
          answered = Object.keys(CURRENT.answers).length;
          const pct = Math.round((answered/list.length)*100);
          bar.style.width = pct+'%';
          txt.textContent = pct+'%';
        }
      }, { passive:true });
    }

    // ==================== تصحيح وإصدار النتيجة ====================
    function grade(list){
      let correct = 0;
      list.forEach(q=>{
        const picked = document.querySelector(`input[name="q_${q.id}"]:checked`);
        if(picked && Number(picked.value) === Number(q.answer)) correct++;
      });
      const pct = Math.round((correct/list.length)*100);
      return { correct, total:list.length, pct };
    }

    // ==================== شهادة سريعة (PNG) ====================
    async function drawCertificatePNG({name, pct, total, honored, sigImg}){
      const W = 1200, H = 800;
      const c = document.createElement('canvas');
      c.width=W; c.height=H;
      const g = c.getContext('2d');

      // خلفية
      g.fillStyle = '#ffffff'; g.fillRect(0,0,W,H);
      g.fillStyle = '#111827'; g.textAlign='center';

      // عنوان
      g.font = 'bold 44px Cairo, Noto Kufi Arabic, system-ui';
      g.fillText(honored ? 'شهادة امتياز' : 'شهادة إتمام', W/2, 110);

      // اسم
      g.font = '36px Cairo, Noto Kufi Arabic, system-ui';
      g.fillText(`يُمنح ${honored?'وسام الامتياز إلى':'هذا الوسام إلى'}: ${name||'متدرّب'}`, W/2, 200);

      // تفاصيل
      g.font = '28px Cairo, Noto Kufi Arabic, system-ui';
      g.fillText(`النتيجة: ${pct}% من ${total} سؤالًا`, W/2, 260);
      if(!honored){
        g.fillStyle = '#ef4444';
        g.fillText('تنبيه: الامتياز يتطلب ≥ 90% ومع ≥ 20 سؤالًا.', W/2, 300);
        g.fillStyle = '#111827';
      }

      // خط فاصل
      g.strokeStyle = '#e5e7eb'; g.lineWidth = 2;
      g.beginPath(); g.moveTo(120, 340); g.lineTo(W-120, 340); g.stroke();

      // التوقيع
      g.textAlign='left';
      g.font = '22px Cairo, Noto Kufi Arabic, system-ui';
      g.fillText('التوقيع:', 140, 580);
      if(sigImg){
        const iw = 360, ih = 160;
        g.drawImage(sigImg, 220, 510, iw, ih);
      } else {
        g.fillStyle = '#6b7280';
        g.fillText('(لا يوجد توقيع مُرفق)', 220, 580);
        g.fillStyle = '#111827';
      }

      // ختم بسيط (SVG نصي)
      g.textAlign='center';
      g.font = 'bold 18px Cairo';
      g.fillText('Tajweed Trainer', W-180, 580);

      return c.toDataURL('image/png');
    }

    // ==================== ربط الواجهة ====================
    const els = {
      qCount: document.getElementById('qCount'),
      quick5: document.getElementById('quick5'),
      start: document.getElementById('startQuiz'),
      areaQuiz: document.getElementById('quizArea'),
      areaSetup: document.querySelector('.card'),
      list: document.getElementById('qList'),
      back: document.getElementById('backToSetup'),
      submit: document.getElementById('submitQuiz'),
      result: document.getElementById('resultArea'),
      rName: document.getElementById('rName'),
      rScore: document.getElementById('rScore'),
      rHonorNote: document.getElementById('rHonorNote'),
      learner: document.getElementById('learnerName'),
      sectionChips: document.getElementById('sectionChips'),
      sigFile: document.getElementById('sigFile'),
      sigPreview: document.getElementById('sigPreview'),
      sigCanvas: document.getElementById('sigPad'),
      sigClear: document.getElementById('sigClear'),
      useCanvasSig: document.getElementById('useCanvasSig'),
      downloadCert: document.getElementById('downloadCert')
    };

    // لوحة التوقيع
    (function initSignaturePad(){
      const c = els.sigCanvas, g = c.getContext('2d');
      let drawing=false, last=null;
      const to = p=>({x:p.offsetX, y:p.offsetY});
      c.addEventListener('pointerdown', e=>{ drawing=true; last=to(e); });
      c.addEventListener('pointermove', e=>{
        if(!drawing) return;
        const p=to(e); g.strokeStyle='#111'; g.lineWidth=2; g.lineCap='round';
        g.beginPath(); g.moveTo(last.x,last.y); g.lineTo(p.x,p.y); g.stroke(); last=p;
      });
      window.addEventListener('pointerup', ()=> drawing=false);
      els.sigClear.addEventListener('click', ()=>{ g.clearRect(0,0,c.width,c.height); });
    })();

    // ملف صورة توقيع
    let SigImage = null;
    els.sigFile.addEventListener('change', ()=>{
      const f = els.sigFile.files?.[0];
      if(!f) return;
      const url = URL.createObjectURL(f);
      els.sigPreview.src = url; els.sigPreview.style.display='block';
      const img = new Image(); img.onload = ()=>{ SigImage = img; }; img.src = url;
    });
    els.useCanvasSig.addEventListener('click', ()=>{
      const img = new Image(); img.onload = ()=>{ SigImage = img; els.sigPreview.src = img.src; els.sigPreview.style.display='block'; };
      img.src = els.sigCanvas.toDataURL('image/png');
    });

    // بدء
    window.addEventListener('DOMContentLoaded', async ()=>{
      try{
        await loadBank();
        renderSectionChips();
      }catch(e){
        console.error('خطأ أثناء التهيئة:', e);
        alert('حدث خطأ أثناء التهيئة. راجع Console.');
      }
    });

    // اختبار قصير
    els.quick5.addEventListener('click', ()=>{ els.qCount.value = 5; });

    // بدء الاختبار
    els.start.addEventListener('click', async ()=>{
      await loadBank();
      const count = Math.max(1, parseInt(els.qCount.value||'20',10));
      const enabled = getEnabledSections();
      if(enabled.length===0){ alert('يرجى تفعيل قسم واحد على الأقل.'); return; }
      const set = sampleQuestions(count, enabled);
      CURRENT = { total:set.length, answers:{}, selected:set, score:0 };
      await renderQuiz(set);
      els.areaQuiz.classList.remove('hidden');
      document.getElementById('resultArea').classList.add('hidden');
      window.scrollTo({top:0,behavior:'smooth'});
    });

    // العودة
    els.back.addEventListener('click', ()=>{
      els.areaQuiz.classList.add('hidden');
      document.getElementById('resultArea').classList.add('hidden');
      window.scrollTo({top:0,behavior:'smooth'});
    });

    // تصحيح
    els.submit.addEventListener('click', ()=>{
      const g = grade(CURRENT.selected);
      CURRENT.score = g.pct;
      els.rName.textContent = els.learner.value || 'متدرّب';
      els.rScore.textContent = `${g.pct}% (${g.correct}/${g.total})`;
      const honored = (g.pct >= 90) && (g.total >= MIN_FOR_HONOR);
      els.rHonorNote.textContent = honored
        ? 'مبروك! مؤهل لشهادة الامتياز.'
        : (g.total < MIN_FOR_HONOR
              ? 'تنبيه: لا تُمنح شهادة الامتياز إذا كان عدد الأسئلة أقل من 20.'
              : 'يمكنك إعادة المحاولة لرفع النسبة إلى 90% فأعلى.');
      els.areaQuiz.classList.add('hidden');
      document.getElementById('resultArea').classList.remove('hidden');

      // تفعيل زر تنزيل الشهادة
      els.downloadCert.disabled = false;
      els.downloadCert.onclick = async ()=>{
        const dataURL = await drawCertificatePNG({
          name: els.learner.value || 'متدرّب',
          pct: g.pct, total: g.total,
          honored,
          sigImg: SigImage
        });
        const a = document.createElement('a');
        a.href = dataURL;
        a.download = honored ? 'Honor-Certificate.png' : 'Certificate.png';
        a.click();
      };
    });
  </script>
</body>
</html>
